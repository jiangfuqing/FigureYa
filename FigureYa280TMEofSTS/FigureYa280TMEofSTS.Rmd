---
title: "FigureYa280TMEofSTS"
params:
  author: "Xiaofan Lu; Yasi Zhang"
  reviewer: "Ying Ge"
  date: "2025-05-20"
output: html_document
---

**Author(s)**: `r params$author`
**Reviewer(s)**: `r params$reviewer`
**Date**: `r params$date`

# Academic Citation
If you use this code in your work or research, we kindly request that you cite our publication:

Xiaofan Lu, et al. (2025). FigureYa: A Standardized Visualization Framework for Enhancing Biomedical Data Interpretation and Research Efficiency. iMetaMed. https://doi.org/10.1002/imm3.70005


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 需求描述
# Demand description

软组织肉瘤（STSs）

Soft-tissue sarcomas (STSs)

![](example.png)

出自：<https://www.nature.com/articles/s41586-019-1906-8>

图1 | SICs表现出显著不同的肿瘤微环境（TME）。本图基于TCGA SARC队列（n = 213）。a. 按SIC和组织学类型划分的TCGA SARC队列构成。b. 通过MCP-counter Z值定义的各SIC组TME组成。NK细胞指自然杀伤细胞。c. 按SIC分组的免疫TME功能相关基因标志物表达。d. 按SIC分组的免疫检查点相关基因表达。校正P值通过双侧Kruskal-Wallis检验的Benjamini-Hochberg校正获得。

Source: <https://www.nature.com/articles/s41586-019-1906-8>

Fig. 1 | The SICs exhibit strongly different TMEs. This figure refers to the TCGA SARC cohort (n = 213). a, Composition of the TCGA SARC cohort by SIC, and histology. b, Composition of the TME by SIC as defined by the MCP-counter Z- scores. NK cells, natural killer cells. c, Expression of gene signatures related to the functional orientation of the immune TME by SIC. d, Expression of genes related to immune checkpoints by SIC. Adjusted P values are obtained from Benjamini–Hochberg correction of two-sided Kruskal–Wallis tests P values.

# 应用场景
# Application scenarios

用MCPcounter计算免疫富集得分，根据MCPcounter结果进行分型。

我们曾众筹过FigureYa56immune_inflitration，也是用TCGA的表达数据计算免疫浸润，并画热图。我们这次画的图信息更丰富。

The immune enrichment scores were calculated using MCP-counter, and subtyping was performed based on the MCP-counter results.

We previously conducted a crowdfunding project (FigureYa56immune_infiltration), which also used TCGA expression data to compute immune infiltration and generate heatmaps. However, the current visualization provides more comprehensive analytical dimensions.

# 环境设置
# Environment Setup


```{r}
source("install_dependencies.R")
```

```{r eval=FALSE}

install.packages("devtools")
library(devtools)
install_github("ebecht/MCPcounter",ref="master", subdir="Source")
```

# 加载包
# Loading packages

```{r}
library(MCPcounter)
library(GSVA)
library(ComplexHeatmap)
library(ClassDiscovery)
library(gplots)
library(RColorBrewer)

# 自定义函数
# Custom Function
standarize.fun <- function(indata=NULL, halfwidth=NULL, centerFlag=T, scaleFlag=T) {
  outdata=t(scale(t(indata), center=centerFlag, scale=scaleFlag))
  if (!is.null(halfwidth)) {
    outdata[outdata>halfwidth]=halfwidth
    outdata[outdata<(-halfwidth)]= -halfwidth
  }
  return(outdata)
}

# 显示英文报错信息
# Show English error messages
Sys.setenv(LANGUAGE = "en")

# 禁止chr转成factor
# Prevent character-to-factor conversion
options(stringsAsFactors = FALSE)
```

# 输入文件
# Input Files

从XENA下载数据：

TCGA-SARC.star_fpkm.tsv.gz，表达谱数据FPKM，已经过`log2(fpkm+1)`转换，下载地址：<https://xenabrowser.net/datapages/?dataset=TCGA-SARC.star_fpkm.tsv&host=https%3A%2F%2Fgdc.xenahubs.net&removeHub=https%3A%2F%2Fxena.treehouse.gi.ucsc.edu%3A443>

gencode.v36.annotation.gtf.gene.probemap，ID/Gene Mapping，下载地址同上。

TCGA-SARC.clinical.tsv.gz，临床信息，下载地址：<https://xenabrowser.net/datapages/?dataset=TCGA-SARC.clinical.tsv&host=https%3A%2F%2Fgdc.xenahubs.net&removeHub=https%3A%2F%2Fxena.treehouse.gi.ucsc.edu%3A443>

Data downloaded from XENA:

TCGA-SARC.star_fpkm.tsv.gz, expression profile data FPKM, already transformed by `log2(fpkm+1)`, download link: <https://xenabrowser.net/datapages/?dataset=TCGA-SARC.star_fpkm.tsv&host=https%3A%2F%2Fgdc.xenahubs.net&removeHub=https%3A%2F%2Fxena.treehouse.gi.ucsc.edu%3A443>

gencode.v36.annotation.gtf.gene.probemap, ID/Gene Mapping, download link same as above.

TCGA-SARC.clinical.tsv.gz, clinical information, download link: <https://xenabrowser.net/datapages/?dataset=TCGA-SARC.clinical.tsv&host=https%3A%2F%2Fgdc.xenahubs.net&removeHub=https%3A%2F%2Fxena.treehouse.gi.ucsc.edu%3A443>
