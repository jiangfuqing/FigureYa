---
title: "FigureYa173fancybar"
author: "Xiaofan Lu"
reviewer: "Ying Ge, Junyi Shen"
date: "2025-5-20"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 需求描述
# Requirement

我想众筹这篇文章的Figure 4i和j，是同一种类型的图。这个图，可以比较组内的情况，然后还可以合并组内的数据，再比组间。还有这种可以直接实现出图的代码。
I'm crowdfunding for Figures 4i and 4j in this article. They are the same type of graph. This graph allows for comparison within groups, merging data within groups, and comparing across groups. Code is also available to directly generate the graph.

![](example.png)

出自<https://doi.org/10.1016/j.ebiom.2020.102724>
From <https://doi.org/10.1016/j.ebiom.2020.102724>

Fig. 4. Practical testing of U-HAPPY CT in three clinical scenarios.

**图的解读**
**Interpretation of the Figure**

图中绿红蓝是三个大组，内部又用同一色系的渐变色画了多个亚组。
The green, red, and blue colors in the figure represent the three main groups, with multiple subgroups drawn within them using gradients of the same color scheme.

仔细看，其中红色和蓝色大组分别画了半透明的红色和蓝色误差线。
Look closely, the red and blue groups have semi-transparent red and blue error bars, respectively.

用base plot，就像画笔一样，一笔一笔画出想要添加的元素。
Using a base plot is like painting a brush, adding the elements you want, stroke by stroke.

# 应用场景
# Application Scenarios

多组柱状图(mean ± se; se = sd/sqrt(n))，某些组同时存在亚组，并进行组间比较和亚组内比较。
Multiple group bar charts (mean ± se; se = sd/sqrt(n)), with some groups containing subgroups and performing both inter-group and intra-subgroup comparisons.

注意：有些杂志要求，对数据的描述不允许使用se（视觉上感觉离散度更小），要使用sd，请留意。
Note: Some journals prohibit the use of se in data descriptions (visually giving a smaller sense of dispersion). Use sd instead. Please note this.

该绘图代码在出图前需要不断调整坐标或文字位置，需要在理解的基础上加以使用。
This plotting code requires constant adjustment of coordinates or text positions before plotting, so it should be used with understanding.

# 环境设置
# Environment Setup

自定义函数求解se
Custom Function to Solve for se

```{r}
se <- function(x) sd(x)/sqrt(length(x))
```

# 输入文件
# Input File

multicenter_validation_*.txt，每个亚组的观测值对应图中的一个bar，放到一个单独的文件里，只需提供diff这一列。
multicenter_validation_*.txt, where each subgroup's observation corresponds to a bar in the plot. Place these in a separate file. Only the diff column is required.

```{r}
prefix <- "multicenter_validation_" # 输入文件的文件前缀 # File prefix for the input file

# 加载图中绿色大组对应的数据
# Load the data corresponding to the green group in the figure
full1 <- read.table(paste0(prefix,"full_NJDTH_UI.txt"),sep = "\t",check.names = F,stringsAsFactors = F,header = T,row.names = NULL)

# 加载图中红色大组对应的数据
# Load the data corresponding to the red group in the figure
semi1 <- read.table(paste0(prefix,"semi_NJDTH_UI.txt"),sep = "\t",check.names = F,stringsAsFactors = F,header = T,row.names = NULL)
semi2 <- read.table(paste0(prefix,"semi_PZTH_UI.txt"),sep = "\t",check.names = F,stringsAsFactors = F,header = T,row.names = NULL)
semi3 <- read.table(paste0(prefix,"semi_SYCCYHC_UI.txt"),sep = "\t",check.names = F,stringsAsFactors = F,header = T,row.names = NULL)

# 加载图中蓝色大组对应的数据
#Load the data corresponding to the blue group in the picture
manu1 <- read.table(paste0(prefix,"manual_NJDTH_UI.txt"),sep = "\t",check.names = F,stringsAsFactors = F,header = T,row.names = NULL)
manu2 <- read.table(paste0(prefix,"manual_NJDTH_GE.txt"),sep = "\t",check.names = F,stringsAsFactors = F,header = T,row.names = NULL)
manu3 <- read.table(paste0(prefix,"manual_NJDTH_Philips.txt"),sep = "\t",check.names = F,stringsAsFactors = F,header = T,row.names = NULL)
manu4 <- read.table(paste0(prefix,"manual_JSPPH_Siemens.txt"),sep = "\t",check.names = F,stringsAsFactors = F,header = T,row.names = NULL)
manu5 <- read.table(paste0(prefix,"manual_GCPH_Toshiba.txt"),sep = "\t",check.names = F,stringsAsFactors = F,header = T,row.names = NULL)
```

# 计算画图所需的统计量
# Calculate the statistics needed to draw the graph
