---
title: "FigureYa278heatmapPoints"
params:
  author: "Qian Liu; Yasi Zhang"
  reviewer: "Ying Ge"
  date: "2025-05-20"
output: html_document
---

**Author(s)**: `r params$author`
**Reviewer(s)**: `r params$reviewer`
**Date**: `r params$date`

# Academic Citation
If you use this code in your work or research, we kindly request that you cite our publication:

Xiaofan Lu, et al. (2025). FigureYa: A Standardized Visualization Framework for Enhancing Biomedical Data Interpretation and Research Efficiency. iMetaMed. https://doi.org/10.1002/imm3.70005


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 需求描述
# Requirements Description

Heatmap和Bubble plot叠加的图。

Heatmap和Bubble plot用的是两套数据。

Heatmap and Bubble plot overlay.

The Heatmap and Bubble plot use two different sets of data.

![](example.png)

出自：<https://linkinghub.elsevier.com/retrieve/pii/S0092867421009454>

图2. MMRd与MMRp型结直肠癌的免疫细胞组成特征
(A) 相对于癌旁正常组织，MMRp和MMRd肿瘤中免疫细胞簇的成分变化。
MMRp与MMRd组间比较经Kruskal-Wallis检验校正后错误发现率(FDR)＜0.05的细胞类型以星号(*)标注。

Source: <https://linkinghub.elsevier.com/retrieve/pii/S0092867421009454>

Figure 2. The immune compartment in MMRd and MMRp CRC
(A) Compositional changes in immune cell clusters in MMRp and MMRd tumors relative to adjacent normal tissue.
Kruskal-Wallis false discovery rate (FDR) < 0.05 for MMRp versus MMRd are marked with asterisks.

# 应用场景
# Application Scenario

Y叔评价：上下三角的更好替代品。上下三角指的是这个图<https://mp.weixin.qq.com/s/34WRZRBVPHUNRLlzNH2nzw>

同时展示同一对象的两种特征，例如同时展示多个基因在多个样本中的表达量和DNA甲基化水平等等。

Dr.Y's evaluation: A better alternative to upper and lower triangles. The upper and lower triangles refer to this figure <https://mp.weixin.qq.com/s/34WRZRBVPHUNRLlzNH2nzw>

Simultaneously displaying two characteristics of the same object, such as showing both the expression levels and DNA methylation levels of multiple genes across multiple samples, etc.

# 环境设置
# Environment Setup


```{r}
source("install_dependencies.R")

```

# 加载包
# Loading packages

```{r}
library(tidyverse)
library(ggplot2)

# 显示英文报错信息
# Show English error messages
Sys.setenv(LANGUAGE = "en")

# 禁止chr转成factor
# Prevent character-to-factor conversion
options(stringsAsFactors = FALSE)
```

# 输入文件
# Input Files

这里为复现原文准备数据。先筛选patient，可忽略，直接跳到“求平均值和pvalue”。

首先查看原文excel表中的一些关于图表数据的说明：

> 按患者统计的细胞数量
- 该表格显示每位患者（列：Pid）中各免疫细胞类型（行）的细胞计数。仅总细胞数超过1000的样本被纳入分析。与图2A相关。

> 按患者统计的细胞富集情况
- 该表格显示每位患者（列：Pid）中各免疫细胞类型（行）相较于正常样本的富集程度（Pearson残差；详见方法部分）。仅总细胞数超过1000的样本被纳入分析。与图2A相关。

> 组成差异分析
- 该表格展示不同样本组（MMRd、MMRp、正常组）间免疫细胞组成的差异。采用Kruskal-Wallis检验判定显著性变化。与图2A相关。

我们可以看到是对病人进行了一定的筛选：细胞数目总共超过 1000 的病人才用于分析，那么我们在分析数据前就必须对数据进行一定的过滤

首先我们将两个相关的表格数据copy出来准备为两个文件：
1. A_Cell_count_by_patient.txt
2. B_Cell_enrichment_by_patient.txt

Here, data is prepared for the reproduction of the original text. First, filter the patients (this step can be ignored, proceed directly to "Calculating Averages and p-values").

Now, check some explanations about the chart data in the original excel table:

> Cell count by patient
- Table showing the immune cell type (rows) counts for each patient (Pid, columns). Only specimens with over 1000 total cells are included in the analysis. Related to Figure 2A.

> Cell enrichment by patient
- Table showing the immune cell type (rows) enrichment (Pearson-Residual; see Methods) as compared to normals for each patient (Pid, columns). Only specimens with over 1000 total cells are included in the analysis. Related to Figure 2A.

> Compositional differences
- Table showing compositional differences within the immune compartment beteen samples (MMRd, MMRp, Normal). Kruskal-Wallis test was used to determine significant changes. Related to Figure 2A.

We can see that the patients underwent certain filtering: only patients with a total cell count exceeding 1,000 were included in the analysis. Therefore, before analyzing the data, we must perform some filtering on the dataset.

We will extract the two relevant tables of data and prepare them as two separate files:

1. A_Cell_count_by_patient.txt
2. B_Cell_enrichment_by_patient.txt
