---
title: "FigureYa230ImmuneLandscape"
author: "Xiaofan Lu"
reviewers: "Ying Ge,Hui Huang"
date: "2025-5-20"
output: html_document
---
# Academic Citation
If you use this code in your work or research, we kindly request that you cite our publication:

Xiaofan Lu, et al. (2025). FigureYa: A Standardized Visualization Framework for Enhancing Biomedical Data Interpretation and Research Efficiency. iMetaMed. https://doi.org/10.1002/imm3.70005


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 需求描述

我想众筹一个多种算法的风险值和免疫细胞相关性热图（文中Figure 7）

# Requirement Description

I would like to crowdfund a heat map of risk value and immune cell correlation for multiple algorithms (Figure 7 in the article)

![](example.png)

出自<https://www.ijbs.com/v17p0702.htm>
from<https://www.ijbs.com/v17p0702.htm>

Figure 7. Heatmap for immune responses based on CIBERSORT, ESTIMATE, MCPcounter, ssGSEA, and TIMER algorithms among high and low risk group.

# 应用场景

多个热图画在一起。

例文绘制不同免疫富集分析得到结果的综合热图。

不仅限于免疫富集分析结果，还可以用于WGCNA、多组学分析结果的展示。

原文使用了pheatmap的方式对不同的算法做了行注释，我这里提供两种方法；

①原文的pheatmap::pheatmap展示
②采用ComplexHeatmap::pheatmap对不同算法采用不同颜色的热图，后垂直衔接热图展示

图中各种打分的计算方法可参考我们众筹过的FigureYa：

- 计算CIBERSORT得分、ESTIMATE得分，可参考FigureYa211multiCohortImmSubtype<https://k.youshop10.com/VwpAWxx0>
- ssGSEA，可参考FigureYa71ssGSEA<https://k.youshop10.com/hhH631te>
- TIMER，从网站下载TIMER数据可参考FigureYa234panImmune<https://k.youshop10.com/Qis-lxH=>，用immunedeconv包进行TIMER打分可参考FigureYa264epiImmune<https://k.youshop10.com/3FtJ=KyB>

# Application Scenarios

Multiple heat maps are drawn together.

In this example, a comprehensive heat map of the results obtained from different immune enrichment analyses is plotted.

It is not limited to the results of immune enrichment analysis, but can also be used to display the results of WGCNA and multi-omics analysis.

The original article uses pheatmap to make line comments on different algorithms, and I provide two methods here;

(1) The original pheatmap: :p heatmap display
(2) ComplexHeatmap: :p heatmap uses different colors for different algorithms, and then vertically connects the heatmap to display

The calculation methods of various scores in the figure can be referred to our crowdfunded FigureYa:

- To calculate the CIBERSORT score and ESTIMATE score, see FigureYa211multiCohortImmSubtype<https://k.youshop10.com/VwpAWxx0>
- ssGSEA, see FigureYa71ssGSEA <https://k.youshop10.com/hhH631te>
- TIMER, for downloading TIMER data from the website, please refer to FigureYa234panImmune<https://k.youshop10.com/Qis-lxH=>, and for TIMER scoring with the immunedeconv package, please refer to FigureYa264epiImmune<https://k.youshop10.com/3FtJ=KyB>

# 环境设置


# Environment settings


```{r}
source("install_dependencies.R")
```

```{r eval=FALSE}

BiocManager::install("ComplexHeatmap")
BiocManager::install("pheatmap")
```

加载包
load packages

```{r}
library(RColorBrewer)
library(circlize)
library(gplots)
library(viridis)
library(oompaBase)

Sys.setenv(LANGUAGE = "en") #显示英文报错信息 # error messages are displayed in English
options(stringsAsFactors = FALSE) #禁止chr转成factor # chr is not allowed to be converted to factor
```

自定义函数
Custom functions

```{r}
standarize.fun <- function(indata=NULL, halfwidth=NULL, centerFlag=T, scaleFlag=T) {
  outdata=t(scale(t(indata), center=centerFlag, scale=scaleFlag))
  if (!is.null(halfwidth)) {
    outdata[outdata>halfwidth]=halfwidth
    outdata[outdata<(-halfwidth)]= -halfwidth
  }
  return(outdata)
}
```

# 输入文件

easy_input.csv，画热图所需的数据。这里是多种算法获得的免疫浸润数据，每行一个sample，每列一种免疫细胞。可以灵活替换为其他需要画热图的数据，例如基因表达矩阵，那么这里的免疫细胞就替换为基因/蛋白质/通路等等。

热图自上而下分成一块一块的多个类，两种方式提供分类信息：

- 第一种方式是像`easy_input.csv`这样，分类跟细胞名之间用下划线`_`分隔
- 第二种方式是提供一个文件`easy_input_type.csv`，把细胞和分类（这里指不同算法）作为两列放进去，细胞名的顺序跟easy_input.csv里的细胞顺序一致。

easy_input_group.csv，分组信息和连续变量，用于画热图上方的注释。这里的连续变量是risk score（根据它的大小为sample排序），分组信息是risk type。读懂之后可以按照现有的格式添加更多行注释。

# Input files

easy_input.csv, the data needed to draw a heat map. Here are the immune infiltration data obtained by multiple algorithms, one sample per row, one type of immune cell per column. It can be flexibly replaced with other data that needs to be heatmapped, such as gene expression matrix, then the immune cells here are replaced with genes/proteins/pathways, etc.

The heatmap is divided into multiple classes from top to bottom, and provides classification information in two ways:

- The first way is to separate the classification from the cell name with an underscore of '_', like 'easy_input.csv'
- The second way is to provide a file 'easy_input_type.csv' that puts the cells and the classification (in this case) in two columns, and the order of the cell names is the same as the order of the cells in the easy_input.csv.

easy_input_group.csv, group information and continuous variables for annotations above the heatmap. Here the continuous variable is the risk score (sorted by its size) and the grouping information is the risk type. Once you have read it, you can add more lines of comments in the existing format.
