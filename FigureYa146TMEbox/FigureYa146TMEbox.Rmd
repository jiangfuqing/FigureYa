---
title: "FigureYa146TMEbox"
author: "Dongqiang Zeng"
reviewer: "Ying Ge, Junyi Shen"
date: "2025-5-20"
output: html_document
---

# Academic Citation
If you use this code in your work or research, we kindly request that you cite our publication:

Xiaofan Lu, et al. (2025). FigureYa: A Standardized Visualization Framework for Enhancing Biomedical Data Interpretation and Research Efficiency. iMetaMed. https://doi.org/10.1002/imm3.70005


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 需求描述
## Requirement description

计算免疫微环境TMEscore，画出对比的box plot，标出差异显著性。
Calculate the immune microenvironment TMEscore, draw a comparative box plot, and mark the significance of the difference.

![](example.png)

出自<https://cancerimmunolres.aacrjournals.org/content/early/2019/03/06/2326-6066.CIR-18-0436>
From <https://cancerimmunolres.aacrjournals.org/content/early/2019/03/06/2326-6066.CIR-18-0436>

Figure 2. Construction of TME signatures and functional annotation. E, The fraction of TME cells in three gene clusters. Within each group, the scattered dots represent TME cell expression values. We also plotted the Immunoscore of three gene clusters. The thick line represents the median value. The bottom and top of the boxes are the 25th and 75th percentiles (interquartile range). The whiskers encompass 1.5 times the interquartile range. The statistical difference of three gene clusters was compared through the Kruskal–Wallis test. \*, P < 0.05; \*\*, P < 0.01; \*\*\*, P < 0.001; \*\*\*\*, P < 0.0001

## 应用场景
## Application scenarios

这个流程探索的是不同TMEcluster的微环境相关signature的分布是否有差异，同样可以适用于是否复发，是否转移，癌和癌旁的表型数据。
This process explores whether the distribution of microenvironment-related signatures of different TME clusters is different. It can also be applied to recurrence, metastasis, cancer and adjacent phenotypic data.

## 环境设置
## Environment settings


```{r}
source("install_dependencies.R")

```

加载包
Load package

```{r}
library(reshape2)
library(ggplot2)
library(ggpubr)
library(tidyverse)

Sys.setenv(LANGUAGE = "en") #显示英文报错信息 #Display English error message
options(stringsAsFactors = FALSE) #禁止chr转成factor #Display English error message
```

## 输入文件
## Input file

如果你不想计算TMEscore，只是想画带显著性的box plot，可以参考FigureYa12box。或者按照very_easy_input.csv文件准备自己的数据，直接进入“开始画图”。
If you don't want to calculate TMEscore, but just want to draw a significant box plot, you can refer to FigureYa12box. Or prepare your own data according to the very_easy_input.csv file and go directly to "Start drawing".

- easy_input_cluster.txt，样本所在的分类，实际应用时可以替换成是否复发,  是否转移等表型。原文通过CIBERSORT的细胞聚类和基因聚类获得，这一步不太好众筹，流程太长了，如果哪个朋友想要个性化服务再说吧。具体步骤如下：先通过consensuclusterplus2确定细胞的最佳聚类，然后通过kmeans获得cell cluster; 接着通过cell cluster进行了两两差异分析，再通过随机森林降维获得signature gene, 然后再用signature gene通过kmeans聚类获得这个数据中的TMEcluster。
- easy_input_cluster.txt, the classification of the sample, can be replaced with phenotypes such as recurrence or metastasis in actual application. The original text is obtained through CIBERSORT cell clustering and gene clustering. This step is not easy to crowdfund, the process is too long, if any friend wants personalized service, please talk to us. The specific steps are as follows: first determine the best clustering of cells through consensusuclusterplus2, and then obtain cell cluster through kmeans; then perform pairwise difference analysis through cell cluster, and then obtain signature gene through random forest dimensionality reduction, and then use signature gene to obtain TMEcluster in this data through kmeans clustering.

Tumor microenvironment characterization in gastric cancer identifies prognostic and imunotherapeutically relevant gene signatures. 2019, Cancer Immunology Research. DOI: 10.1158/2326-6066.CIR-18-0436 PMID: 30842092

- signature.RData，signature gene set，其中包含代表免疫微环境signature的 TMEscoreA和TMEscoreB，总结于这篇2018年的Nature: TGFbeta attenuates tumour response to PD-L1 blockade by contributing to exclusion of T cells. Nature 2018;554:544–8. https://www.nature.com/articles/nature25501?draft=journal&proof=true1
- signature.RData, signature gene set, which contains TMEscoreA and TMEscoreB representing the immune microenvironment signature, summarized in this 2018 Nature: TGFbeta attenuates tumour response to PD-L1 blockade by contributing to exclusion of T cells. Nature 2018;554:544–8. https://www.nature.com/articles/nature25501?draft=journal&proof=true1

- eset，每个样本的基因表达矩阵。例文整合了多个数据集，数据量庞大。为了尽量减小传输文件的大小，这里的表达矩阵是经过了signature_gene挑选后的矩阵（来自于GSE62254），也因此最后画出的图中pvalue都很小。
- eset, gene expression matrix for each sample. The example paper integrates multiple data sets, and the amount of data is huge. In order to minimize the size of the transfer file, the expression matrix here is the matrix selected by signature_gene (from GSE62254), so the pvalues in the final figure are very small.
