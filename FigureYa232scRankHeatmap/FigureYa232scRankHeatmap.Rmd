---
title: "FigureYa232scRankHeatmap"
author: "Zongcheng Li"
reviewers: "Ying Ge, Hui Huang"
date: "2025-5-20"
output: html_document
---
# Academic Citation
If you use this code in your work or research, we kindly request that you cite our publication:

Xiaofan Lu, et al. (2025). FigureYa: A Standardized Visualization Framework for Enhancing Biomedical Data Interpretation and Research Efficiency. iMetaMed. https://doi.org/10.1002/imm3.70005

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 需求描述

这种图把富集的上调和下调的基因展示一下，常规用柱状图或点状图，太腻味了，热图要高大上一些，几乎用于所有差异分析的构图需求。

跟FigureYa114ternaryCluster的图相似，这次是单细胞的，改动较大，还是发起众筹吧。

# Requirement Description

This kind of diagram shows the up-regulated and down-regulated genes of enrichment, and the conventional histogram or dot plot is too conventional, and the heat map is more advanced, which can be used for all the compositional needs of differential analysis.

Similar to the figure of FigureYa114ternaryCluster, this time it is single-celled, and the changes are large, so let's launch crowdfunding.

![](example.png)

出自<https://linkinghub.elsevier.com/retrieve/pii/S0092867420300568>
from<https://linkinghub.elsevier.com/retrieve/pii/S0092867420300568>

Figure 4. Downregulation of Antioxidant Genes in Aged Oocytes of Early-Stage Follicles
(B) Heatmaps showing the distribution of DEGs between old and young monkeys in each oocyte subtype. The gray bars on the left of the heatmaps denote DEGs shared by at least two oocyte subtypes and the others are oocyte subtype-specific DEGs.

# 应用场景

与上述例文（例文1）出自同一实验室的[例文2](<https://www.cell.com/developmental-cell/pdf/S1534-5807(20)30877-7.pdf)也出现了很多同类型的Figure 。推荐对照着阅读，有助于学习思路、理解图的用法。

- 单细胞RNA-seq的表达谱和基因功能富集分析结果展示。例文1的Figure 1H和例文1的Figure 1G，画法可参考FigureYa206scHeatmap。
- 主成分分析。
  - 例文1的Figure 3A和B从PCA结果就能看出基因表达模式跟细胞类型的关系，可参考FigureYa222PCAgene。
  - 例文1的Figure S6H用颜色和形状展示两个层面的分组信息，可参考FigureYa101PCA。
  - 例文2的Figure 2D，用3D图形展示3个主成分，可参考FigureYa164PCA3D
- 各细胞类型中富集的上下调基因。例文1的Figure 4B、Figure 5B，例文2的Figure 2A和B、Figure 4C。本文档带你实现。
- 对比展示两组细胞里上下调核心转录因子的调控关系。例文2的Figure 5I，可参考FigureYa199crosslink。

# Application Scenarios

Many figures of the same type appear in [Example 2] (<https://www.cell.com/developmental-cell/pdf/S1534-5807(20)30877-7.pdf) from the same laboratory as the above example (Example 1). It is recommended to read it in comparison to help you learn ideas and understand the use of diagrams.

- Single-cell RNA-seq expression profile and gene function enrichment analysis results are displayed. Figure 1H in Example 1 and Figure 1G in Example 1 can be drawn by FigureYa206scHeatmap.
- Principal component analysis.
- Figure 3A and B in Example 1 can see the relationship between gene expression patterns and cell type from the PCA results, please refer to FigureYa222PCAgene.
- Figure S6H in Example 1 shows the grouping information at two levels with color and shape, see Figure Ya101PCA.
- Figure 2D in Example 2 shows the three principal components in 3D, see FigureYa164PCA3D
- Up- and down-regulated genes enriched in each cell type. Figure 4B and Figure 5B in Example 1, Figure 2A and B and Figure 4C in Example 2. This document takes you through the implementation.
- Compare and contrast the regulatory relationship between the two groups of cells to downregulate the core transcription factors. For Figure 5I in Example 2, see FigureYa199crosslink.

# 环境设置


# Environment settings


```{r}
source("install_dependencies.R")

```

加载包
load packages

```{r}
library(Seurat)
library(dplyr)
library(pheatmap)
Sys.setenv(LANGUAGE = "en") #显示英文报错信息 # error messages are displayed in English
options(stringsAsFactors = FALSE) #禁止chr转成factor # chr is not allowed to be converted to factor
```

# 输入文件

sc.seurat.Rdata，单细胞RNA-seq预处理获得的文件。出自FigureYa206scHeatmap，文件较大，已上传至微云<https://share.weiyun.com/vZiSM9pB>

怎样获得这个文件？拖到文末看“附：单细胞RNA-seq数据预处理”

# Input files

sc.seurat.Rdata, file obtained from single-cell RNA-seq pretreatment. From FigureYa206scHeatmap, the file size is large, and it has been uploaded to the Weiyun <https://share.weiyun.com/vZiSM9pB>

How do I get this document? Drag to the end of the article to see "Attached: Single-cell RNA-seq data preprocessing"

```{r}
(load("sc.seurat.Rdata"))

## 提取oocytes subtype的细胞的数据
# 从文章附件获得oocytes subtype的细胞ID（191 young oocytes, 227 old oocytes）
# 用到第一列cell ID（用于提取oocytes subtype的细胞）
## Extract the data of oocytes subtype cells
# Obtain the cell ID of oocytes subtype from the attachment (191 young oocytes, 227 old oocytes)
# Use the first column of cell IDs (for extracting oocytes subtype cells)
meta_oo <- readxl::read_excel(path = "1-s2.0-S0092867420300568-mmc2.xlsx", sheet = 2)
sc_oo <- sc[,meta_oo$cell] # only 414 (not 418?! ) cells in the metadata

## 自己的数据，就不涉及取子集，直接用sc就好，用下面这行代替上面两行：
## Your own data, it doesn't involve taking subsets, just use sc, and use the following line instead of the above two lines:
# sc_oo <- sc
```

cluster信息，即图中的4个sybtype C1-C4，这里直接用文章附件`1-s2.0-S0092867420300568-mmc2.xlsx`文件第二列，包含原文获得的细胞所在的cluster信息。
The cluster information, that is, the 4 subtypes C1-C4 in the figure, is directly used in the second column of the '1-s2.0-S0092867420300568-mmc2.xlsx' file attached to the article, which contains the cluster information of the cells obtained in the original text.

```{r}
sc_oo$seurat_clusters <- meta_oo$cluster[match(colnames(sc_oo), meta_oo$cell)]
## 自己的数据做聚类，可参考文末看“Seurat自带的无监督聚类”，替换掉上面这行即可
## For clustering of your own data, you can refer to "Seurat's own unsupervised clustering" at the end of the article, and replace the above line
```

# 差异基因筛选
# Differential gene screening

To identify aging-associated DEGs between old and young individuals in each specific cell type, the function FindMarkers in the R package Seurat was used based on t test. Only genes with an average **log2-transformed difference greater than 0.5**, a **P value less than 0.05** and a **percentage of expressed cells greater than 70%** were considered as aging-associated DEGs.
