---
title: "FIgureYa31lasso_update"
author: "Ya Zhang, Ying Ge; Yijing Chen"
date: "2025-5-20"
output: html_document
---

# Academic Citation
If you use this code in your work or research, we kindly request that you cite our publication:

Xiaofan Lu, et al. (2025). FigureYa: A Standardized Visualization Framework for Enhancing Biomedical Data Interpretation and Research Efficiency. iMetaMed. https://doi.org/10.1002/imm3.70005


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 需求描述
# Requirement description

画出paper中的lasso回归图，给出图中线所对应的基因顺序。

将纳入signature的变量拟合成一个变量，作为nomogram的输入。

Draw the lasso regression plot from the paper, giving the order of the genes corresponding to the lines in the plot.

Fit the variables that are included in the signature to a variable that is used as input to the nomogram.

![](example.png)

出自<https://linkinghub.elsevier.com/retrieve/pii/S1470-2045(13)70491-1>

lasso结果怎么解读？看这篇：<https://mp.weixin.qq.com/s/Odf3zYOu77DvN-ph4gHPJQ>

from<https://linkinghub.elsevier.com/retrieve/pii/S1470-2045(13)70491-1>

How to interpret lasso results? Read this: <https://mp.weixin.qq.com/s/Odf3zYOu77DvN-ph4gHPJQ>

# 应用场景
# Application scenario

筛选差异基因之后，进一步筛选有预后意义的基因，组成基因表达signature。

LASSO对于高维度、强相关、小样本的生存资料数据较为适用。

After screening for differential genes, genes with prognostic significance are further screened to compose the gene expression signature.

LASSO is more suitable for high-dimensional, strongly correlated, and small-sample survival data.

# 环境设置
# Environment setting

采用R包`glmnet`，它是目前最好用的拟合广义线性模型的R包，由`LASSO` 回归的发明人，斯坦福统计学家 Trevor Hastie 领衔开发。

The R package `glmnet` is used, which is the best R package available for fitting generalized linear models, lead by Trevor Hastie, the Stanford statistician who invented `LASSO` regression.

```{r,fig.width=8, fig.height=6}
source("install_dependencies.R")
#install.packages("glmnet")
#install.packages("survival")
library("glmnet")
library("survival")
source("nonzeroCoef.R")
Sys.setenv(LANGUAGE = "en") #显示英文报错信息 display English error messages
options(stringsAsFactors = FALSE) #禁止chr转成factor prohibit the conversion of chr to factor
```

# 输入数据
# Input data

输入文件有两个，一个是生存信息`easy_input_suv.csv`，一个是基因表达矩阵`easy_input_exp.csv`。

`easy_input_suv.csv`，生存信息，至少包含三列，分别为patient IDs、follow up time、life status

`easy_input_exp.csv`，基因表达矩阵，每行一个基因，每列一个patient，跟`suv.csv`里的`patient ID`一致。

There are two input files: one is the survival information file `easy_input_suv.csv`, and the other is the gene expression matrix file `easy_input_exp.csv`.

`easy_input_suv.csv`, the survival information, contains at least three columns for patient IDs, follow up time, life status

`easy_input_exp.csv`, gene expression matrix, one gene per row, one patient per column, consistent with the `patient ID` in `suv.csv`.

```{r}
myexpr <- read.csv("easy_input_exp.csv", header = T,row.names = 1)
myexpr[1:3,1:4]
mysurv <- read.csv("easy_input_suv.csv", header = T,row.names = 1)
head(mysurv)

#检查样品信息跟表达量矩阵的样品是否一致
#check that the sample information is consistent with the samples in the expression matrix
if (all(colnames(myexpr) %in% rownames(mysurv))){
  warning("两个文件的patient ID是一致的")
} else{
  warning("两个文件的patient ID不一致")
}
```

# 开始画图
# Start drawing

## 算出lambda值
## Calculate the lambda value

```{r}
cvfit = cv.glmnet(t(myexpr), Surv(mysurv$months,mysurv$status),
                  #10倍交叉验证，非必须限定条件，这篇文献有，其他文献大多没提
                  #10-fold cross-validation, non-required qualification, available in this paper, mostly unmentioned in others
                  #nfold=10,
                  family = "cox"
                  )
plot(cvfit)

#两个lambda值均可采用，具体lambda选值要根据自己实验设计而定。
#此处使用`lambda min`
#Both lambda values can be used, the exact lambda selection depends on your own experimental design.
#Here we use `lambda min`.
cvfit$lambda.min #最佳lambda值 best lambda value
cvfit$lambda.1se #一倍SE内的更简洁的模型 a more concise model in double SE

fit <- glmnet(t(myexpr), Surv(mysurv$months,mysurv$status),
               family = "cox")

#用包自带的函数画图
#use the built-in functions of the package to plot the graph
plot(fit, label = TRUE)
```

## 修改画图函数
## Modify the plotting function

原函数打印序号，需要修改画图函数，改为打印基因名

如果基因太多，打印基因名也看不清。在右侧列出图例，这样看起来更清晰。

The original function prints the serial number, you need to modify the plotting function to print the gene name instead.

If there are too many genes, it is hard to see the gene names. List the legend on the right side, so that it looks clearer.
