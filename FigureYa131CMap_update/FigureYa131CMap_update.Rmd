---
title: "FigureYa131CMap_update"
author: "Rongfang Shen"
reviewer: "Ying Ge, Junyi Shen"
date: "2025-5-20"
output: html_document
---

# Academic Citation
If you use this code in your work or research, we kindly request that you cite our publication:

Xiaofan Lu, et al. (2025). FigureYa: A Standardized Visualization Framework for Enhancing Biomedical Data Interpretation and Research Efficiency. iMetaMed. https://doi.org/10.1002/imm3.70005


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
```
# 需求描述
# Description of the Task

药物分析，Connectivity map(CMap)分析鉴定能够靶向干性特征的潜在化合物/抑制剂，重复出下图
Drug analysis: Connectivity map (CMap) analysis identifies potential compounds/inhibitors that can target stemness features. Reproduce the figure below.

![](example.png)

出自<https://www.sciencedirect.com/science/article/pii/S0092867418303581?via%3Dihub#app2>
From<https://www.sciencedirect.com/science/article/pii/S0092867418303581?via%3Dihub#app2>

Figure 7. Correlation of cancer stemness with drug resistance – Connectivity map analysis
(A) Heatmap showing enrichment score (positive in blue, negative in red) of each compound from the CMap for each cancer type. Compounds sorted from right to left by descending number of cancer type significantly enriched.
(B) Heatmap showing each compound (perturbagen) from the CMap that share Mechanism of actions (rows). Sorted by descending number of compound with shared mechanism of actions.
See also Figure S7 and Tables S3 and S4.

# 应用场景
Application Scenario

任何感兴趣的差异基因都可以用CMap分析得到可能的靶向药物，关于CMap的介绍和原理可以参考[The Connectivity Map-揭示化合物，基因和疾病状态的功能联系](https://mp.weixin.qq.com/s/N0ZvANnWsbBB3XJpSr1j1g).
Any differentially expressed genes of interest can be used for CMap analysis to identify possible targeted drugs. For an introduction to CMap and its principles, refer to The Connectivity Map - Revealing functional links between compounds, genes, and disease states. (https://mp.weixin.qq.com/s/N0ZvANnWsbBB3XJpSr1j1g).

[CMap build 02](https://portals.broadinstitute.org/cmap/)包含~1,300小分子化合物处理的Affymetrix芯片数据，目前还可以使用但是已经不更新和维护了。考虑到新版的[clue.io](https://clue.io/)query只能上传最多150个上调和下调差异基因，而CMap build 02版本可以总共上传1000个基因（上调和下调基因总和不超过1000个基因）。
[CMap build 02](https://portals.broadinstitute.org/cmap/) contains Affymetrix chip data of ~1,300 small molecule compounds. It is still available but no longer updated and maintained. Considering that the new version of [clue.io](https://clue.io/) query can only upload up to 150 up-regulated and down-regulated differentially expressed genes, while CMap build 02 can upload a total of 1,000 genes (the total number of up-regulated and down-regulated genes does not exceed 1,000 genes).

作者在查询这个步骤依旧使用的是CMap build 02.
The author still uses CMap build 02 for this query step.

而在分析mechanism of actions (MoA)和drug-target部分则选用的是[CLUE](https://clue.io/)，对感兴趣的小分子进行MoA药物作用机制分析，探索其共同的内在作用机制。
In the analysis of mechanism of actions (MoA) and drug-target, [CLUE](https://clue.io/) is used to perform MoA drug action mechanism analysis on the small molecules of interest and explore their common intrinsic mechanisms of action.

# 环境设置
# Environment Setup


```{r}
source("install_dependencies.R")

```

加载包
Loading Packages

```{r}
library(xlsx)
library(tidyverse)
library(GEOquery)
library(plyr)
library(circlize)
library(ComplexHeatmap)

options(java.parameters = "-Xmx8000m")
Sys.setenv(LANGUAGE = "en") #显示英文报错信息 Display English error message
options(stringsAsFactors = FALSE) #禁止chr转成factor Disable conversion of chr to factor
```

# PART 1: 重复出文章Figure 7A
# PART 1: Repeat Figure 7A

## 生成CMap输入文件
## Generate Input Files for CMap

pandif_mRNAsi.xlsx，这里用的是TCGA泛癌数据根据mRNAsi指标高低求出的差异基因。出自例文附件Table S3<https://ars.els-cdn.com/content/image/1-s2.0-S0092867418303581-mmc3.xlsx>，你也可以用任何你感兴趣的差异基因作为输入。
pandif_mRNAsi.xlsx, here we use the differentially expressed genes from the TCGA pan-cancer data according to the mRNAsi index. From the example text attachment Table S3 <https://ars.els-cdn.com/content/image/1-s2.0-S0092867418303581-mmc3.xlsx>, you can also use any differentially expressed genes you are interested in as input.
