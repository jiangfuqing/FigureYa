---
title: "FigureYa212drugTargetV2"
author: "小丫画图出品"
date: "2021-1-3"
output: html_document
---
欢迎关注“小丫画图”公众号，回复“小白”，看小视频，实现点鼠标跑代码。

小丫微信: epigenomics  E-mail: figureya@126.com

作者：大鱼海棠

单位：中国药科大学国家天然药物重点实验室，生物统计与计算药学研究中心

小丫编辑校验

# Academic Citation
If you use this code in your work or research, we kindly request that you cite our publication:

Xiaofan Lu, et al. (2025). FigureYa: A Standardized Visualization Framework for Enhancing Biomedical Data Interpretation and Research Efficiency. iMetaMed. https://doi.org/10.1002/imm3.70005


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 需求描述

需求一：这篇文章的Figure5F，G图，同时要包括按照文中的方法对非肿瘤组织进行纯化。

需求二：根据PRISM和CTRP2.0药物敏感性AUC值数据、以及CCLE表达谱数据，预测TCGA亚组潜在性治疗药物。
我们之前众筹的FigureYa105GDSC也用到了pRRophetic。不同于FigureYa105GDSC，这个数据是药物敏感性AUC值，以及药物的范围更加广泛。里面提到一个算法ISOpureR，通过解卷积消除肿瘤样本中掺杂的正常样本，提纯肿瘤表达矩阵，感觉也还不错。

![](example.png)

出自<https://academic.oup.com/bib/advance-article/doi/10.1093/bib/bbaa164/5891146>

Figure 5. Identification of candidate agents with higher drug sensitivity in high-PPS score patients.
(A) A venn diagram for summarizing included compounds from CTRP and PRISM datasets (see also Table S12).
(B) Volcano plot of differential expression between bulk HCC samples and hepatoma cell lines (Wilcoxon rank-sum test: adjust P < 0.05, and log2FC > 1). Stroma markers are highlighted in deep colour (see also Table S13).
(C) Volcano plot of differential expression between purified HCC samples and hepatoma cell lines (Wilcoxon rank-sum test: adjust P < 0.05, and log2FC > 1). Stroma markers are highlighted in deep color (see also Table S13).
(D) Comparison of estimated sorafenib’s sensitivity (logAUC) between PI3K-MTOR altered and unaltered groups.
(E) Schematic outlining the **strategy to identify agents** with **higher drug sensitivity in high PPS score patients**.
(F) The results of Spearman’s correlation analysis and differential drug response analysis of six **CTRP-derived compounds**.
(G) The results of Spearman’s correlation analysis and differential drug response analysis of six **PRISM-derived compounds**.
Note that lower values on the y-axis of boxplots imply greater drug sensitivity.

**涉及到的几个概念：**

- PPS：prognosis-associated signature (PPS), which had superior ability to predict **survival in TP53-mutant patients** compared with previously established population-based signatures. Further, three therapeutic targets (CANT1, CBFB and PKM) and two agents (irinotecan and YM-155) were identified for those high-risk patients, holding the potential to improve current population-based therapeutic strategies in HCC.

- 两个药物敏感性数据库：
  - The [CTRP2.0](https://portals.broadinstitute.org/ctrp.v2.1/) contains the sensitivity data for **481 compounds over 835 CCLs**
  - the [PRISM](https://www.theprismlab.org) contains the sensitivity data for **1448 compounds over 482 CCLs**.
  - Both two datasets provide the **area under the dose–response curve (area under the curve—AUC)** values as a **measure of drug sensitivity**, and lower AUC values indicate **increased sensitivity to treatment**.

- CCLE和KNN：
  - Expression profile data and somatic mutation data of human cancer cell lines (CCLs) were obtained from the Broad Institute-**Cancer Cell Line Encyclopedia (CCLE)** project (https://portals.broadinstitute.org/ccle/)
  - **K-nearest neighbor (k-NN)** imputation was applied to impute the missing AUC values. Before imputation, compounds with more than 20% of missing data were excluded.
  - Because the CCLs in both datasets were obtained from the CCLE project, molecular data in **CCLE were thus used for subsequent CTRP and PRISM analyses.**

# 应用场景

筛选对癌症亚组可能有效的化合物/药物，例文用了多种方式相互佐证。

- 用PRISM和CTRP 发现了12个 candidate compounds identified showed a higher drug sensitivity in PPS score-high patients
- **above analyses alone could not support** the conclusion that these compounds had therapeutic effect in HCC. Therefore, **multiple- perspective analyses** were subsequently conducted to investigate the therapeutic potential of these compounds in HCC.
  - We first used the **CMap analysis** to find compounds of which gene expression patterns were oppositional to the HCC-specific expression patterns (i.e. gene expression increased in tumor tissues but decreased by treatment of certain compounds).
  - Secondly, **fold-change differences of the expression levels (including mRNA- and protein-level) of candidates’ drug targets** between tumor and normal tissue were calculated, and a higher fold change value indicated a greater potential of candidate agent for HCC treatment.
  - Thirdly, a comprehensive **literature search** was performed in PubMed (https://www.ncbi.nlm.nih. gov/pubmed/) to find out the experimental and clinical evidence of candidate compounds in treating HCC.

其中CMap analysis及多种证据的结果展示可参考FigureYa213customizeHeatmap

下面带你实现前两种方法：利用细胞系表达谱（CCLE）及药敏结果（PRISM和CTRP），预测癌症样本的药敏结果。

> 使用本代码或分析思路请引用例文：

Chen Yang, Xiaowen Huang, Yan Li, Junfei Chen, Yuanyuan Lv, Shixue Dai, Prognosis and personalized treatment prediction in TP53-mutant hepatocellular carcinoma: an in silico strategy towards precision oncology, Briefings in Bioinformatics, bbaa164, https://doi.org/10.1093/bib/bbaa164

# 环境设置


```{r}
source("install_dependencies.R")
```

```{r, eval=FALSE}

install.packages("pRRophetic_0.5.tar.gz", repos = NULL, type = "source")
```

加载包

```{r}
library(tidyverse) # 用于读取MAF文件
library(ISOpureR) # 用于纯化表达谱
library(impute) # 用于KNN填补药敏数据
library(pRRophetic) # 用于药敏预测
library(SimDesign) # 用于禁止药敏预测过程输出的信息
library(ggplot2) # 绘图
library(cowplot) # 合并图像

Sys.setenv(LANGUAGE = "en") #显示英文报错信息
options(stringsAsFactors = FALSE) #禁止chr转成factor
```

自定义函数显示进度

```{r}
display.progress = function (index, totalN, breakN=20) {
  if ( index %% ceiling(totalN/breakN)  ==0  ) {
    cat(paste(round(index*100/totalN), "% ", sep=""))
  }
}
```

# 输入文件

文件较大，已上传至微云，请点击链接下载<https://share.weiyun.com/c9oY6n0T>

LIHC.TPM.txt，基因表达矩阵。计算PPS得分和药敏预测，都基于这个表达矩阵。实际应用时把这个表达矩阵替换成你自己的数据。

data_mutations_mskcc.txt，maf突变数据，用于提取癌症亚型，例文提取的是TP53-mutant patients。

以下文件通用，使用时请引用原文。

- 17gene.txt，用于计算PPS得分。17-gene set in the model with the largest C-index value was considered as PPS。出自原文Table S3，
- CTRP_AUC_raw.txt，用于制作CTRP AUC矩阵，原始数据来自Correlating chemical sensitivity and basal gene expression reveals mechanism of action，2016 Nature Chemical Biology，Supplementary Data Set 1 2
- CTRP_ccl_anno.txt，CTRP_cpd_anno.txt，分别出自Supplementary Data Set 1，Supplementary Data Set 2
- PRISM_AUC.txt，数据来自https://depmap.org/portal/download/ Drug sensitivity AUC (PRISM Repurposing Secondary Screen) 19Q4
- CCLE_RNAseq_rsem_genes_tpm_20180929.txt，细胞系表达谱，作为药敏预测时的训练集。出自<https://portals.broadinstitute.org/ccle/data>.
