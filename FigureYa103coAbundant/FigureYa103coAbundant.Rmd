---
title: "FigureYa103coAbundant"
author: "Xiaofan Lu, Taojun Ye"
reviewer: "Ying Ge"
date: "2025-5-20"
output: html_document
---


# Academic Citation
If you use this code in your work or research, we kindly request that you cite our publication:

Xiaofan Lu, et al. (2025). FigureYa: A Standardized Visualization Framework for Enhancing Biomedical Data Interpretation and Research Efficiency. iMetaMed. https://doi.org/10.1002/imm3.70005


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# 设置knitr代码块的全局选项 / Set global options for knitr code chunks
```

## 需求描述

这个图，想知道怎么聚类的。WGCNA这个方法不会做，输入的是代谢化合物在各个sample里的浓度。

## Requirement description

I want to know how to cluster this graph. The WGCNA method does not perform it, it only inputs the concentration of metabolic compounds in each sample.

![](example.png)

出自<https://microbiomejournal.biomedcentral.com/articles/10.1186/s40168-019-0683-9>

from<https://microbiomejournal.biomedcentral.com/articles/10.1186/s40168-019-0683-9>

Clusters of co-abundant serum metabolites were identified using the R package WGCNA [65]. Signed, weighted metabolite co-abundance correlation networks were calculated for all examined individuals. A scale-free topology criterion was used to choose the soft threshold β = 14 for serum metabolites correlations. Clusters were identified with the dynamic hybrid tree-cutting algorithm using a deepSplit of 4 [66]. The serum polar metabolite and serum molecular lipid clusters (labelled P01???P42 and L01???L30, respectively) were collectively termed metabolite clusters.

**图的解读：**利用hybrid dynamic branch-cutting法构建加权共表达网络，构建方法跟FigureYa15WGCNA不一样，采用的是mannually而不是automatically构建网络。需要对网络模块和其他变量的相关性进行分析、筛选、外部聚类和热图绘制（展示显著性）。

**Interpretation of the figure: * * Using the hybrid dynamic branch cutting method to construct a weighted co expression network, the construction method is different from FigureYa15WGCNA, and the network is constructed manually rather than automatically. It is necessary to analyze, screen, externally cluster, and heat map the correlation between network modules and other variables (to demonstrate significance).

## 应用场景

计算并用热图展示WGCNA找出的共表达模块跟表型数据（数量性状）之间的相关性。

## Application scenarios

Calculate and display the correlation between the co expression modules identified by WGCNA and phenotype data (quantitative traits) using a heatmap.

## 环境设置


## Environment settings


```r

if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install("impute")
BiocManager::install("preprocessCore")
BiocManager::install("GO.db")
BiocManager::install("AnnotationDbi")
BiocManager::install("WGCNA") #MAC系统，可能需要手动下载WGCNA后本地安装，下载链接：https://horvath.genetics.ucla.edu/html/CoexpressionNetwork/Rpackages/WGCNA/WGCNA_1.67.tgz
#MAC system, may require manual download of WGCNA and local installation. Download link: https://horvath.genetics.ucla.edu/html/CoexpressionNetwork/Rpackages/WGCNA/WGCNA_1.67.tgz
```

加载包

library packages

```{r}
source("install_dependencies.R")
# 加载WGCNA包，用于加权基因共表达网络分析
# Load the WGCNA package for weighted gene co-expression network analysis
library(WGCNA)

# 加载ClassDiscovery包，用于癌症类型分类等发现任务
# Load the ClassDiscovery package for cancer type classification and other discovery tasks
library(ClassDiscovery)

# 加载gplots包，提供各种绘图函数增强可视化
# Load the gplots package which provides various plotting functions to enhance visualization
library(gplots)

# 加载pheatmap包，用于绘制精美的热图
# Load the pheatmap package for creating beautiful heatmaps
library(pheatmap)

# 设置环境变量使R显示英文报错信息，便于查找解决方案
# Set environment variable to display error messages in English for easier troubleshooting
Sys.setenv(LANGUAGE = "en")

# 禁止字符串自动转换为因子类型，避免数据处理中的意外转换
# Disable automatic conversion of strings to factors to avoid unexpected data type conversions
options(stringsAsFactors = FALSE)
```

## 输入文件

需要两种输入文件，两个的文件的行要一一对应：

- easy_input_data.txt，表达矩阵，用于构建加权共表达网络。每行一个sample，每列一个基因。
- easy_input_anno.txt，表型信息，用于计算module score跟它的相关性分析及聚类热图绘制。每行一个sample，每列一种表型，这里的列是代谢物浓度，还可以是其他数量性状、临床指标等等。如果只想构建共表达网络，就不需要这个文件。

## Input file

Two types of input files are required, and the lines of the two files should correspond one-to-one:

- easy_input_data.txt， Expression matrix, used to construct weighted co expression networks. One sample per row, one gene per column.
- easy_input_anno.txt， Phenotypic information is used to calculate the correlation analysis between module score and it, as well as to draw clustering heatmaps. Each row has one sample, and each column has one phenotype. The columns here represent metabolite concentrations, as well as other quantitative traits, clinical indicators, and so on. If you only want to build a co expression network, you don't need this file.
