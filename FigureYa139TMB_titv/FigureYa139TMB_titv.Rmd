---
title: "FigureYa139TMB_titv"
author: "Rongfang Shen"
reviewer: "Ying Ge, Junyi Shen"
date: "2025-5-20"
output: html_document
---

# Academic Citation
If you use this code in your work or research, we kindly request that you cite our publication:

Xiaofan Lu, et al. (2025). FigureYa: A Standardized Visualization Framework for Enhancing Biomedical Data Interpretation and Research Efficiency. iMetaMed. https://doi.org/10.1002/imm3.70005


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

## 需求描述
## Requirement description

输入TCGA突变的数据，重复出如下图。
Input TCGA mutation data and repeat the following figure.

![](example.png)

出自<https://www.nature.com/articles/ng.2868>
From <https://www.nature.com/articles/ng.2868>

Figure 1 Plot of the number of nonsynonymous mutations per megabase in craniopharyngiomas (n = 15) in comparison to a broad range of pediatric and adult tumors n = 3,083). Data for all other tumor types, as well as the figure design, were taken from Lawrence et al.14. Each dot in this plot corresponds to a **matched tumor-normal pair**. The vertical position indicates the **frequency of somatic mutations** in that exome. Tumor types are ordered on the basis of their median nonsynonymous frequency, and within each tumor type, tumor-normal pairs are ordered from lowest to highest frequency. The relative proportions of **six different possible base-pair substitutions** are indicated at the bottom. Craniopharyngioma data are derived from whole-exome sequencing of 15 tumor-normal pairs, including 12 adamantinomatous and 3 papillary craniopharyngioma, and are marked in red.

In consonance with the benign histology of these tumors, we identified only a relatively small number of nonsynonymous somatic mutations in both craniopharyngioma subtypes when compared to large cohorts of other tumor types14 (Fig. 1). The **nonsynonymous mutation rate** of 0.9 per Mb in the craniopharyngioma samples was similar to that found in a number of pediatric tumors, as well as that in low-grade tumors in adults, for example, World Health Organization– classified grade I meningioma15 (Fig. 1). 58% of the mutations were **cytosine to thymidine at CpG dinucleotides**, which is consistent with spontaneous deamination and not a carcinogen-induced process (Fig. 1)14. As we anticipated, the allelic fraction for many of the mutations was very low (median, 3%; range, 0.96–48%).

**图的解读**
**Interpretation of the graph**

把颅咽管瘤跟其他癌症一同展示，便于做对比。图分上下两部分：
Display craniopharyngioma with other cancers for easy comparison. The graph is divided into two parts:

上半部分散点图：
Upper part scatter plot:

- 散点图中每个点对应1个matched tumor-normal pair
- 纵坐标为突变频率
- 横坐标的各种肿瘤按nonsynonymous frequency的中值排列，每个肿瘤内部按突变频率排序
- Each point in the scatter plot corresponds to a matched tumor-normal pair
- The vertical axis is the mutation frequency
- The various tumors on the horizontal axis are arranged according to the median of nonsynonymous frequency, and each tumor is sorted by mutation frequency

底部为每个matched tumor-normal pair中6种碱基突变方式所占的比例
The bottom is the proportion of the six base mutations in each matched tumor-normal pair

## 应用场景
## Application scenario

同时展示TCGA泛癌样本TMB情况以及6种碱基转换和颠换情况(T>G, T>A, T>C, C>G, C>T, C>A )。像例文一样用于直观展示感兴趣癌种与TCGA其他癌种的整体TMB情况。
Show the TMB of TCGA pan-cancer samples and the six base conversions and transversions (T>G, T>A, T>C, C>G, C>T, C>A) at the same time. Like the example text, it is used to intuitively display the overall TMB of the cancer of interest and other TCGA cancers.

还可以自定义分组，例如对比同一疾病不同亚型。
You can also customize the grouping, such as comparing different subtypes of the same disease.

## 环境设置
## Environment settings


```r

BiocManager::install("maftools")
```

加载包
Loading Packages

```{r}
source("install_dependencies.R")
library(TCGAbiolinks)
library(maftools)
library(ggplot2)
library(tidyverse)
library(ggsci)

Sys.setenv(LANGUAGE = "en") #显示英文报错信息 #Display English error message
options(stringsAsFactors = FALSE) #禁止chr转成factor #Disable conversion of chr to factor
```

## 输入数据的下载
## Download input data

下载TCGA全部癌种的maf文件。
Download the maf files of all TCGA cancer types.

这里我们用TCGAbiolinks下载maf文件。（也可以用R包TCGAmutations，这个包里面已经下载并且处理成maf的格式了，但是版本不是最新的。）
Here we use TCGAbiolinks to download the maf files. (You can also use the R package TCGAmutations, which has been downloaded and processed into maf format, but the version is not the latest.)

```r
tumors <- TCGAbiolinks::getGDCprojects()$project_id %>% .[grep("TCGA", .)] %>% str_sub(., 6)
# pipeline 可以选择muse, varscan2, somaticsniper, mutect2 在这里选用mutect2
# pipeline can choose muse, varscan2, somaticsniper, mutect2. Here, mutect2 is selected
maflist <- tumors %>% lapply(., GDCquery_Maf, save.csv = FALSE, directory = "GDCdata", pipelines = "mutect2") %>% lapply(., read.maf)
names(maflist) <- tumors
# 保存数据，以后可以反复使用
# Save the data for repeated use later
save(maflist, file = "maflist.RData")
TMB.dat <- lapply(maflist, getSampleSummary)
titv.dat <- lapply(maflist, function(x)titv(maf = x, plot = FALSE, useSyn = FALSE#不添加同义突变 #Do not add synonymous mutations
                                            )) %>% lapply(., function(x)x$fraction.contribution)
save(TMB.dat, titv.dat, file = "TMB_titv.RData")
```

## 准备突变频率输入数据
## Prepare mutation frequency input data

先准备上半部分散点图的数据（TMB.dat），底部图（titv.dat）中样本顺序按照散点图的TMB大小排列。
First prepare the data of the scatter plot in the upper part (TMB.dat), and the order of samples in the bottom figure (titv.dat) is arranged according to the TMB size of the scatter plot.
