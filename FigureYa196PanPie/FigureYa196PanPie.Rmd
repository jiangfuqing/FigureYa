---
title: "FigureYa196PanPie"
author: "Xiaofan Lu"
reviewers: "Ying Ge,Hui Huang"
date: "2025-5-20"
output: html_document
---
# Academic Citation
If you use this code in your work or research, we kindly request that you cite our publication:

Xiaofan Lu, et al. (2025). FigureYa: A Standardized Visualization Framework for Enhancing Biomedical Data Interpretation and Research Efficiency. iMetaMed. https://doi.org/10.1002/imm3.70005


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 需求描述

把分组的数据直接用扇形图来展示不同临床预后分期的分布差异，看起来很漂亮。

# Requirement Description

It looks beautiful to use the grouped data directly in a fan chart to show the distribution differences of different clinical prognostic stages.

![](example.png)

出自<https://www.nature.com/articles/s41388-019-1026-9>

from <https://www.nature.com/articles/s41388-019-1026-9>

Fig. 4 Identification of CNV-driven rRNA metabolism-related genes with clinical relevance.
f, g Pie charts showing the Chi-squared test of clinicopathologic factors for PRE in CRC (f) and LUAD (g) tumor samples from the TCGA.

图 4 具有临床相关性的 CNV 驱动的 rRNA 代谢相关基因的鉴定。f、g饼图显示了来自TCGA的CRC（f）和 LUAD（g）肿瘤样本中 PRE 临床病理因素的卡方检验。

# 应用场景

搞清楚输入数据跟图的对应关系、理解每部分代码所画的内容，就可以套用到更多类型的数据上。
更多泛癌的图看这里<https://k.koudai.com/Wi1xos9X>

# Application Scenarios
Once you understand the mapping between input data and visual outputs, as well as the role of each code block in generating plots, you can adapt this workflow to broader data types.
Explore additional pan-cancer visualizations here: <https://k.koudai.com/Wi1xos9X>


# 环境设置


# Environment Configuration


```{r}
source("install_dependencies.R")
```

```{r eval=FALSE}

install.packages(c("dplyr", "ggplot2"))
```

加载包
load package

```{r}
library(dplyr)
library(ggplot2)
Sys.setenv(LANGUAGE = "en") #显示英文报错信息 # error messages are displayed in English
options(stringsAsFactors = FALSE) #禁止chr转成factor # It is forbidden to convert chr into factor
```

# 输入文件
# Input files

easy_input.txt

- 第一列sample ID，每行一个sample，扇形大小对应每一类sample的数量；
- 第二列Risk有两类：high和low，对应表格中的两行；
- 第三列往后，对应表格中的各列。

easy_input.txt

-First column (Sample ID): Each row represents one sample. The sector size in visualizations corresponds to the number of samples in each category.

-Second column (Risk): Contains two classes: High and Low, mapped to the two rows in the table.

-Third column onward: Correspond to the columns in the original table.

```{r}
dat <- read.table("easy_input.txt",row.names = 1,sep = "\t",header = T,check.names = F,stringsAsFactors = F)
head(dat)

# 按Risk分成High和Low，计算各列数值。
# The value of each column is calculated according to the risk divided into high and low.
gname <- "Risk"
vname <- setdiff(colnames(dat), gname)
pie.high <- pie.low <- list()
fisher.p <- c()
for (i in vname) {
  tmp <- table(dat[,gname], dat[,i])
  p <- format(fisher.test(tmp)$p.value,digits = 2)
  names(p) <- i
  fisher.p <- c(fisher.p, p)

  pie.dat <-
    tmp %>% as.data.frame() %>% group_by(Var1) %>% mutate(Pct = Freq/sum(Freq)) %>% as.data.frame()

  # 表格内的两行对应Risk的两类：Risk high和Risk low
  # The two rows in the table correspond to the two types of Risk: Risk high and Risk low
  pie.high[[i]] <- pie.dat[which(pie.dat$Var1 == "High"),]
  pie.low[[i]] <- pie.dat[which(pie.dat$Var1 == "Low"),]
}
```

# 开始画图

# Start plotting

用base plot画图，如果你要查看某部分代码的效果，请从plot所在的行到当前位置一起，整段运行。

f you want to preview the output of a specific code segment, run the entire code block from the line containing the plot() command to the current cursor position.
