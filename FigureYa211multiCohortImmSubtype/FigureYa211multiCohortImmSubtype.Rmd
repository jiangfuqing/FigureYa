---
title: "FigureYa211multiCohortImmSubtype"
author: "Xiaofan Lu"
reviewers: "Ying Ge,Hui Huang"
date: "2025-5-20"
output: html_document
---
# Academic Citation
If you use this code in your work or research, we kindly request that you cite our publication:

Xiaofan Lu, et al. (2025). FigureYa: A Standardized Visualization Framework for Enhancing Biomedical Data Interpretation and Research Efficiency. iMetaMed. https://doi.org/10.1002/imm3.70005


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 需求描述

以往的分子分型都是基于基因表达来做的，这有一个是基于多数据集免疫细胞的，能众筹吗？输出Fig.1 A和B。

# Requirement Description

In the past, molecular typing was based on gene expression, but one of them is based on multiple datasets of immune cells, can it be crowdfunded? Outputs Fig.1 A and B.

![](example.png)

出自<https://www.cell.com/molecular-therapy-family/nucleic-acids/fulltext/S2162-2531(20)30259-6>
from<https://www.cell.com/molecular-therapy-family/nucleic-acids/fulltext/S2162-2531(20)30259-6>

Figure 1. The Landscape of Immuno-cell Infiltration in the TME of HNSC
(A) Unsupervised clustering of tumor-infiltrating immune cells in five independent HNSC cohorts. Rows represent tumor-infiltrating immune cells, and columns represent samples.
(B) Kaplan-Meier curves for overall survival (OS) of all HNSC patients with immune cell-infiltrating classes. Log rank test showed an overall p = 0.018.

跟FigureYa201ClusterCorrelation、FigureYa203ComBat、FigureYa204PCAscore出自同一篇文章。
It's from the same article as FigureYa201ClusterCorrelation, FigureYa203ComBat, and FigureYa204PCAscore.

# 应用场景

不同平台的表达谱，去除批次效应后，计算免疫富集，并进行分子分型与生存分析。

原文：We performed the CIBERSORT and ESTIMATE algorithms to quantify the activity or enrichment levels of immune cells in HNSC tumor tissues.

# Application Scenarios

Expression profiles of different platforms, after removing batch effects, immune enrichment was calculated, and molecular typing and survival analysis were performed.

Original: We performed the CIBERSORT and ESTIMATE algorithms to quantify the activity or enrichment levels of immune cells in HNSC tumor tissues.

# 环境设置


# Environment settings


```{r}
source("install_dependencies.R")
```

```{r eval=FALSE}

install.packages("estimate", repos="http://r-forge.r-project.org", dependencies=TRUE)
```

加载包

```{r}
library(sva)
library(ConsensusClusterPlus)
library(survminer)
library(survival)
library(estimate)
library(pheatmap)
source("CIBERSORT.R")

Sys.setenv(LANGUAGE = "en") #显示英文报错信息 # error messages are displayed in English
options(stringsAsFactors = FALSE) #禁止chr转成factor # chr is not allowed to be converted to factor
```

自定义函数，用于数据标准化并截断极端值
Custom functions for data normalization and truncation of extreme values

```{r}
standarize.fun <- function(indata=NULL, halfwidth=NULL, centerFlag=T, scaleFlag=T) {
  outdata=t(scale(t(indata), center=centerFlag, scale=scaleFlag))
  if (!is.null(halfwidth)) {
    outdata[outdata>halfwidth]=halfwidth
    outdata[outdata<(-halfwidth)]= -halfwidth
  }
  return(outdata)
}
```

# 输入文件

表达矩阵文件较大，已上传微云<https://share.weiyun.com/kvInGjRq>，数据下载和预处理可参考FigureYa203ComBat。

TCGA hnsc的表达数据和生存信息：tcga_hnsc.expr.txt和tcga_hnsc.surv.txt。可以用TCGAbiolinks下载，或从[xena](https://xenabrowser.net/datapages/)下载。

来自GEO的芯片数据和生存信息：gse41613.expr.txt和gse41613.surv.txt，gse65858.expr.txt和gse65858.surv.txt

# Input files

The expression matrix file is large, and the microcloud <https://share.weiyun.com/kvInGjRq> has been uploaded, and the data download and preprocessing can be found in FigureYa203ComBat.

Expression data and survival information :tcga_hnsc.expr.txt and tcga_hnsc.surv.txt of TCGA hnsc. It can be downloaded with TCGAbiolinks, or from [xena](https://xenabrowser.net/datapages/)

Chip data and survival information from GEO:gse41613.expr.txt and gse41613.surv.txt, gse65858.expr.txt and gse65858.surv.txt

## 加载不同平台的表达谱、去除批次效应
## Load expression profiles from different platforms to remove batch effects
