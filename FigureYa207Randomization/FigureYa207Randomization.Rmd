---
title: "FigureYa207Randomization"
params:
  author: "Xiaofan Lu; Yasi Zhang"
  reviewer: "Ying Ge"
  date: "2025-05-20"
output: html_document
---

**Author(s)**: `r params$author`
**Reviewer(s)**: `r params$reviewer`
**Date**: `r params$date`

# Academic Citation
If you use this code in your work or research, we kindly request that you cite our publication:

Xiaofan Lu, et al. (2025). FigureYa: A Standardized Visualization Framework for Enhancing Biomedical Data Interpretation and Research Efficiency. iMetaMed. https://doi.org/10.1002/imm3.70005


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 需求描述
# Demand description

我想众筹文章Figure 1B的计算方法，用Randomization test来检测多个差异基因的分布情况，属于差异基因的横向分析，从不同的角度来认识差异基因。

I would like to crowdsource the computational method for Figure 1B in the article, which uses a Randomization test to examine the distribution of multiple differentially expressed genes. This belongs to the horizontal analysis of differentially expressed genes, providing different perspectives to understand them.

![](example.png)

出自：<https://www.aging-us.com/article/102766/text>

图1. 胆管癌（在TCGA中命名为CHOL）异常表达基因及其在不同癌症类型中的表达模式。(B) 针对筛选出的异常基因，展示了相关功能基因（主要包括必需基因、CGC、癌基因等）的分布情况。**与同等数量正常表达基因的随机结果相比**，被鉴定为功能基因的异常基因数量更少。

**随机化检验**

为确定特定基因分类检测频率的显著性，我们进行了随机化检验：**随机选取数量相等的正常表达基因**。该过程重复1,000次（显著性根据出现比例估算），用于评估**观察到的平均相关性值是否高于真实平均相关性**。

Source: <https://www.aging-us.com/article/102766/text>

Figure 1. Abnormally expressed genes in CCA (named CHOL in TCGA) and their expression patterns across diverse cancer types. (B) For screened abnormal genes, distributions of associated functional genes (mainly including essential gene, CGC, oncogene, etc) are presented. **Compared with random result in the equal number of normally expressed genes**, fewer abnormal genes are identified as functional genes.

**Randomization test**

To determine the significance of a detected frequency of special gene classification, we performed a **randomization test by randomly selecting normally expressed genes with equal numbers**. This procedure was repeated 1,000 times (the significance was estimated based on the proportion of times), and was used to estimate **whether the average correlation values observed were higher than the real average correlation**.

# 应用场景
# Application scenarios

Randomization test来检验差异表达基因的模式是否是随机出现的。

灵活运用，不仅限于差异表达基因的检验，任何感兴趣的基因集都可以作为检验的对象。

Randomization test is used to examine whether the patterns of differentially expressed genes (DEGs) occur randomly.

This method is flexible and versatile, not limited to testing DEGs—any gene set of interest can serve as the subject of analysis.

> 注意：以下为个人见解
> Note: The following are my personal opinions

FigureYa156enrichSimulation的富集检验零假设为两者分布是否一致，当p>0.05时，小概率事件发生了，因而接受原假设，认为分布没有统计学差异，故没有富集；

这里的随机化检验，使用的方法和富集检验如出一辙，均为重抽样计算概率分布密度，但其零假设的关键是基因分类标签的可交换性，或者说是否是DEG与基因的分类标签是无关的（参考：<https://www.uvm.edu/~statdhtx/StatPages/Randomization%20Tests/null_hypotheses.html>）

对于本众筹的原文，实际上作者也可以采用富集检验，来证明DEG是与CGC是弱关联（低富集），但是这里使用随机化检验，证明DEG的基因名的与CGC的标签无关。

甚至我们觉得，随机化检验可以没有零假设，只考虑计算的概率，如本众筹中计算得到，在1000次随机抽样中，DEG有95.6%的概率出现在正常表达的基因中，也就是说只有4.4%的概率出现在异常表达的基因中。

The enrichment test in FigureYa156enrichSimulation has the null hypothesis that the distributions of the two are consistent. When p>0.05, a small probability event occurs, thus accepting the null hypothesis and concluding there is no statistically significant difference in distribution, hence no enrichment;

The randomization test used here employs a method virtually identical to the enrichment test, both involving resampling to calculate probability distribution density. However, the key to its null hypothesis lies in the exchangeability of gene classification labels, or in other words, whether being a DEG is independent of gene classification labels (reference: <https://www.uvm.edu/~statdhtx/StatPages/Randomization%20Tests/null_hypotheses.html>).

For the original article in this crowdfunding project, the authors could have actually used an enrichment test to demonstrate that DEGs are weakly associated with CGC (low enrichment). But here they used a randomization test to prove that DEG gene identities are unrelated to CGC labels.

We even think that a randomization test might not need a null hypothesis at all, focusing only on the calculated probabilities. As computed in this crowdfunding project: in 1000 random samplings, DEGs had a 95.6% probability of appearing in normally expressed genes, meaning only a 4.4% probability of appearing in abnormally expressed genes.

# 环境设置
# Environment Setup


```{r}
source("install_dependencies.R")

BiocManager::install("TCGAbiolinks")
```

# 加载包
# Loading packages

```{r}
library(TCGAbiolinks)
library(DESeq2)
library(shape)

# 显示英文报错信息
# Show English error messages
Sys.setenv(LANGUAGE = "en")

# 禁止chr转成factor
# Prevent character-to-factor conversion
options(stringsAsFactors = FALSE)
```

# 输入文件的获得
# Obtaining Input Files

如果你的数据已经处理成easy_input_diff.csv和easy_input_func_genes.txt，就可以跳过这步，直接进入“输入文件”。

If your data has already been processed into easy_input_diff.csv and easy_input_func_genes.txt, you can skip this step and proceed directly to the "Input Files" section.

## 用TCGAbiolinks下载表达数据和样本信息。
## Download expression data and sample information using TCGAbiolinks
