---
title: "FigureYa192breakpoint"
author: "Xiaofan Lu"
reviewer: "Ying Ge, Junyi Shen"
date: "2025-5-20"
output: html_document
---
# Academic Citation
If you use this code in your work or research, we kindly request that you cite our publication:

Xiaofan Lu, et al. (2025). FigureYa: A Standardized Visualization Framework for Enhancing Biomedical Data Interpretation and Research Efficiency. iMetaMed. https://doi.org/10.1002/imm3.70005


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 需求描述

# Requirement

求众筹Fig 2，输入seer数据，循环cox模型，lowess平滑并绘图。
Find the crowdfunding Fig 2, input the seer data, loop the cox model, smooth it with lowess and plot it.

![](example.png)

出自<https://ascopubs.org/doi/full/10.1200/JCO.2016.67.5140>
fromhttps://ascopubs.org/doi/full/10.1200/JCO.2016.67.5140

Fig 2. LOWESS smoother fitting curves of stage migration and overall survival and **determination of structural break points with use of the Chow test**. The fitting bandwidth was 2/3. (A) and (B) Stage migration was estimated by logistic regression after adjusting for T staging, N staging, histology, tumor location, and operation type in both cohorts. (C) and (D) Overall survival was estimated by using the Cox proportional hazards regression model after adjusting for sex, age, T staging, histology, and operation type. ELN, examined lymph node.

这里画C图，cox。A图logistic就是对OR做平滑，原理都是一样的。
Here is Figure C, cox. logistic in Graph A is smoothing out OR, and the principle is the same for both.

# 应用场景

# Application Scenarios

大样本下寻找某计数变量对预后风险的变点。
Search for the change point of a certain counting variable on prognostic risk in a large sample.

这里以SEER数据库的数据为例，也可以用于自己的数据。
Here, we take the data from the SEER database as an example, which can also be used for our own data.

# 环境设置

# Environment Setup


```{r}
source("install_dependencies.R")
```

```{r eval=FALSE}

install.packages("strucchange")
```

加载包
Loading package

```{r}
library(survival)
library(strucchange)
Sys.setenv(LANGUAGE = "en") #显示英文报错信息   # Display an English error message
options(stringsAsFactors = FALSE) #禁止chr转成factor  # prohibit chr from being converted to factor
```

# 输入文件的获得

# Acquisition of Input Files

如果你的数据已经整理成easy_input.csv的格式，就跳过这步，直接进入“输入文件”。
If your data has been organized into the format of easy_input.csv, skip this step and go directly to "Input File".

加载SEER数据，数据较大，请先解压lung.zip压缩包。
Load the SEER data. The data is quite large. Please extract the lung.zip compressed package first.

```{r eval=FALSE}
dat <- read.table("lung.txt",sep = "\t",row.names = NULL,header = T,check.names = F,stringsAsFactors = F)
View(dat)
```

根据例文清洗数据
Clean the data according to the example text

```{r eval=FALSE}
dat <- dat[which(dat$`Derived AJCC Stage Group, 7th ed (2010-2015)` %in%
                   c("IA","IB","IE","IEA","IEB","II","IIA","IIB","IIE","IIEA","IIEB","III","IIIA")),]
dat <- dat[as.numeric(dat$`Regional nodes examined (1988+)`) >= 1,]

# 保留例文中部分cox回归感兴趣的协变量（我不是很清楚histology和operation type应该看哪列，结果和原文不一样）
# Retain some covariates of interest in cox regression in the example text (I'm not quite sure which column should be looked at for histology and operation type, and the result is different from the original text)
dat <- dat[,c("Regional nodes examined (1988+)",
              "Survival months",
              "Vital status recode (study cutoff used)",
              "Age recode with single ages and 85+",
              "Derived AJCC T, 6th ed (2004-2015)")]
colnames(dat) <- c("ELN","futime","fustat","Age","Tstage")
dat <- dat[which(dat$Tstage != "TX" & dat$Age != "85+ years"),]
dat$Age <- as.numeric(gsub(" years","",dat$Age))
dat$ELN <- as.numeric(dat$ELN)
dat$Tstage <- ifelse(dat$Tstage %in% c("T0","T1","T2"), "T012","T34")
dat <- dat[which(dat$ELN <= 30),]
dat$fustat <- ifelse(dat$fustat == "Alive", 0 ,1)
dat$futime <- as.numeric(dat$futime)

# 把清洗后的数据保存到文件，便于套用
# Save the cleaned data to a file for easy application
write.csv(dat, "easy_input.csv", quote = F, row.names = F)
```

# 输入文件

# Input File

easy_input.csv，每行一个sample，每列一个cox回归感兴趣的协变量。
easy_input.csv, one sample per row, one covariate of interest for cox regression per column.

```{r}
dat <- read.csv("easy_input.csv")
head(dat)
```

# 循环cox模型

# Cyclic cox model

以ELN为1作参照，分别做其他各ELN计数下的cox proportial hazards regression model
Taking ELN as 1 as the reference, the cox proportional hazards regression models under each other ELN count were conducted respectively

```{r}
ctrl <- dat[which(dat$ELN == 1),]
ELN.count <- sort(unique(dat$ELN))
Coxoutput <- NULL

for (count in ELN.count) {
  if(count == 1) {
    next()
  } else {
    treat <- dat[which(dat$ELN == count),]
    tmp <- rbind.data.frame(treat,ctrl)
    tmp$ELN <- ifelse(tmp$ELN == 1, 0 ,1)
    cox <- coxph(Surv(futime, fustat) ~ ELN + Age + Tstage, data = tmp)
    coxSummary <- summary(cox)
    Coxoutput <- rbind.data.frame(Coxoutput,
                                  data.frame(ELN.count = count,
                                             HR = as.numeric(coxSummary$coefficients[,"exp(coef)"])[1],
                                             pvalue = as.numeric(coxSummary$coefficients[,"Pr(>|z|)"])[1],
                                             lower = as.numeric(coxSummary$conf.int[,3][1]),
                                             upper = as.numeric(coxSummary$conf.int[,4][1]),
                                             stringsAsFactors = F),
                       stringsAsFactors = F)
  }
}
head(Coxoutput)
```

# lowess平滑并绘图

# Lowess smoothing and plotting

用base plot画图。如果想理解某一行代码的含义，就从plot开始到该语句一起运行。
Draw a plot using base plot. If you want to understand the meaning of a certain line of code, run from plot to that statement together.
