---
title: "FigureYa308IHS"
params:
  author: "Xiaofan Lu; Yasi Zhang"
  reviewer: "Ying Ge"
  date: "2025-05-20"
output: html_document
---

**Author(s)**: `r params$author`
**Reviewer(s)**: `r params$reviewer`
**Date**: `r params$date`

# Academic Citation
If you use this code in your work or research, we kindly request that you cite our publication:

Xiaofan Lu, et al. (2025). FigureYa: A Standardized Visualization Framework for Enhancing Biomedical Data Interpretation and Research Efficiency. iMetaMed. https://doi.org/10.1002/imm3.70005


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 需求描述
# Requirements Description

我想众筹一下这篇文章里Figure5D，作者写了一个计算基因异质性的方法，然后用VIPER推断检查点蛋白活性以后计算了检查点蛋白的异质性，我想这个方法应该也可以用来计算其他种类蛋白的异质性，应该挺实用的。

FigureYa296VIPER<https://k.youshop10.com/CTEFqnpF>跟这个不一样。这篇里面用的是新版的weighted VIPER，和之前的算法不一样，而且这个图重点是IHS分数的计算，不仅是蛋白活性的计算。

I'd like to crowdfund Figure 5D from this article. The author developed a method to calculate gene heterogeneity, then used VIPER to infer checkpoint protein activity before calculating the heterogeneity of checkpoint proteins. I think this method could also be applied to calculate heterogeneity for other types of proteins - it seems quite practical.

FigureYa296VIPER<https://k.youshop10.com/CTEFqnpF> is different from this one. Here, they used the new weighted VIPER, which has a different algorithm from the previous version. Moreover, the focus of this figure is on the calculation of IHS scores, not just protein activity inference.

![](example.png)

出自：<https://genomemedicine.biomedcentral.com/articles/10.1186/s13073-022-01143-6>

图5. HCC中的免疫异质性。
D，9种共抑制性免疫检查点基因蛋白活性的IHS值。
虚线表示5099种蛋白质的中位IHS值。

Source: <https://genomemedicine.biomedcentral.com/articles/10.1186/s13073-022-01143-6>

Fig. 5 Immune heterogeneity in HCC.
D, IHS of protein activity of 9 co-inhibitory immune checkpoint genes.
Dotted lines indicate the median IHS value across 5099 proteins

# 应用场景
# Requirements Description

通过weighted viper推断检查点蛋白活性并计算异质性。

更多异质性FigureYa看这里<https://k.youshop10.com/S-utnyI7>

- FigureYa114ternaryCluster，在一组样本中某个geneset表达谱变异很大时，**展示这个geneset的所有基因表达异质性**。
- FigureYa223scNMF，适合**异质性较大的样本的聚类分析**。
- FigureYa150diversityScore，用**单细胞DNA测序**数据计算diversity score，用来评价肿瘤异质性。
- FigureYa241scRNA_NMI，利用**单细胞**数据评估同一(时间点)肿瘤样本的**转录异质性**。
- FigureYa308IHS，推断检查点**蛋白活性并计算异质性**。
- FigureYa95pairwise，**多维度相关性**研究，可用于推断体细胞突变和免疫浸润在影响肿瘤异质性上的相关程度。
- FigureYa216MetaREM，**meta分析**的异质性检验，给出Q和pvalue。

Infer checkpoint protein activity and calculate heterogeneity using weighted VIPER.

For more heterogeneity figures, see here<https://k.youshop10.com/S-utnyI7>

- FigureYa114ternaryCluster: When the expression profile of a geneset varies significantly in a group of samples, it **displays the expression heterogeneity of all genes in this geneset**.
- FigureYa223scNMF: Suitable for **cluster analysis of samples with high heterogeneity**.
- FigureYa150diversityScore: Uses **single-cell DNA sequencing** data to calculate a diversity score, which evaluates tumor heterogeneity.
- FigureYa241scRNA_NMI: Utilizes **single-cell** data to assess **transcriptional heterogeneity** within the same tumor sample (at a given time point).
- FigureYa308IHS: Infers checkpoint **protein activity and calculates heterogeneity**.
- FigureYa95pairwise: **Multi-dimensional correlation** analysis, useful for investigating the relationship between somatic mutations and immune infiltration in influencing tumor heterogeneity.
- FigureYa216MetaREM: **Meta-analysis** heterogeneity test, providing Q and p-value.

# 环境设置
# Environment Setup


```{r}
source("install_dependencies.R")
```

```{r eval=FALSE}

install.packages("optparse")
```

# 加载包
# Load packages

```{r}
library(viper)
library(nlme)
library(spatstat.explore)
library(ggplot2)
library(ggrepel)

# 显示英文报错信息
# Show English error messages
Sys.setenv(LANGUAGE = "en")

# 禁止chr转成factor
# Prevent character to factor conversion
options(stringsAsFactors = FALSE)
```

自定义函数以计算IHS

Custom function to calculate IHS

```{r}
CalIHS <- function(vec, clin, method){
  # vec：各样本的活性值
  # clin：样本临床信息，样本顺序应当与活性值的顺序一致，应有Patient列标识样本的患者来源
  # method：nlme和hclust两种
  # 患者内肿瘤异质性越强，得分越高
  # vec: Activity values for each sample
  # clin: Clinical info (must contain 'Patient' column), sample order should match vec
  # method: 'nlme' or 'hclust'
  # Higher scores indicate stronger intratumor heterogeneity

  IHS <- switch(
    method,
    "nlme" = {
      df <- cbind(clin, "regulon" = vec)
      fit <- lme(regulon~1, random=~1|Patient, data=df)
      var <- as.numeric(data.frame(as.character(VarCorr(fit)))[,1])

      var_sum <- data.frame(between_group=var[1],
                            within_group=var[2],
                            std1=var[3],
                            std2=var[4],
                            all=var[1]+var[2],
                            WT=var[2]/(var[1]+var[2]))
      return(var_sum$WT)
    },
    "hclust" = {
      hcs <- unlist(lapply(1:length(unique(clin$Patient)), function(x){
        hc = cutree(hclust(d = dist(vec), method = "ward.D2"), k = x)
        df = cbind(clin, "clust" = hc)
        df = split(df, df$Patient)
        sum(unlist(lapply(df, function(x) length(unique(x$clust)) == 1)))
      }))
      a = auc(ppp(x = (1:length(hcs))/length(hcs), y = hcs/length(hcs)), covariate = "x")
      1-a/(length(hcs-1))
    }
  )
}
```

# 输入文件
# Input Files

Renji_cohort_MR_exp.matrix，样本表达矩阵。每行一个基因，每列一个样本。第一行是样本名，第一列是基因名。下载自<https://zenodo.org/record/7336311#.ZBE6xbRBzt0>

easy_input_cli.csv，样本分组信息。共三列，第一列为样本名，跟表达矩阵里面的样本名一致；第二列是Patient ID；第三列是该Patient的Sample ID。

Renji_cohort_MR_exp.matrix, the sample expression matrix. Each row represents a gene, each column represents a sample. The first row contains sample names, the first column contains gene names. Downloaded from <https://zenodo.org/record/7336311#.ZBE6xbRBzt0>

easy_input_cli.csv, the sample grouping information. Contains three columns: the first column is sample names (matching those in the expression matrix); the second column is Patient ID; the third column is the Sample ID for each Patient.
