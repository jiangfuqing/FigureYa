---
title: "FigureYa264epiImmune"
params:
  author: "Shuwen Cheng; Yasi Zhang"
  reviewer: "Ying Ge"
  date: "2025-05-20"
output: html_document
---

**Author(s)**: `r params$author`
**Reviewer(s)**: `r params$reviewer`
**Date**: `r params$date`

# Academic Citation
If you use this code in your work or research, we kindly request that you cite our publication:

Xiaofan Lu, et al. (2025). FigureYa: A Standardized Visualization Framework for Enhancing Biomedical Data Interpretation and Research Efficiency. iMetaMed. https://doi.org/10.1002/imm3.70005


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 需求描述
# Demand description

我想众筹这篇文章的Figure 1A。

- 此图的内容：在117例CD8+T细胞高浸润的TCGA黑色素瘤样本中，表观遗传调节因子的表达与细胞毒性T淋巴细胞（CTL）评分之间的相关性。注：1.细胞毒性T淋巴细胞（CTL）评分：文献报道（PMID: 30127393）的CD8+T细胞标志与功能的基因的平均表达水平（CD8A、CD8B、GZMA、GZMB和PRF1）。2.CD8+ T细胞高浸润水平：高于TIMER上的四分位数。

- 此图的优点：1.扩展性强，换成其他基因及免疫细胞也可以用。2.实用性强：很密集的展示了很多信息。

- 绘图的难点：1.作者通过5个基因的平均表达量来定义CTL评分，代码如何实现呢？2.如何通过TIMER确定CD8 +T细胞高浸润的TCGA样本？3.CTL评分与TCGA基因表达水平之间的相关性，代码如何实现？4.如何绘制文章中的柱状图？

I would like to crowdfund the creation of Figure 1A for this article.

- Content of the figure: The correlation between the expression of epigenetic regulators and the Cytotoxic T Lymphocyte (CTL) score in 117 TCGA melanoma samples with high CD8+ T-cell infiltration. Notes: 1.CTL score: The average expression level of genes associated with CD8+ T-cell markers and function, as reported in the literature (PMID: 30127393) (CD8A, CD8B, GZMA, GZMB, and PRF1). 2.High CD8+ T-cell infiltration level: Above the upper quartile on TIMER.

- Advantages of this figure: 1.Highly scalable: It can be adapted for other genes and immune cells. 2.Highly practical: It densely presents a large amount of information.

- Challenges in creating the figure: 1.How to implement the code for calculating the CTL score based on the average expression of the five genes? 2.How to identify TCGA samples with high CD8+ T-cell infiltration using TIMER? 3.How to implement the code for calculating the correlation between the CTL score and TCGA gene expression levels? 4.How to reproduce the bar plot shown in the article?

![](example.png)

出自：<https://linkinghub.elsevier.com/retrieve/pii/S1550413121001674>

图1. FTO缺失通过增强肿瘤浸润性T细胞抑制肿瘤生长。
(A) 在117例具有充分CD8+ T细胞浸润的TCGA黑色素瘤样本中（定义为TIMER估算的CD8+ T细胞浸润水平高于上四分位数，详见方法部分），已知表观遗传调控因子表达与细胞毒性T淋巴细胞（CTL）评分（CD8A、CD8B、GZMA、GZMB和PRF1的平均表达量）的Spearman相关性分析。采用Spearman秩相关系数（rho）评估基于秩次的关联性度量。

Source: <https://linkinghub.elsevier.com/retrieve/pii/S1550413121001674>

Figure 1. The absence of FTO inhibits tumor growth by enhancing tumor-infiltrating T cells.
(A) Spearman correlation of the expression of known epigenetic regulators with cytotoxic T lymphocyte (CTL) scores (average expression of CD8A, CD8B, GZMA, GZMB, and PRF1) in 117 TCGA melanoma samples with sufficient CD8+ T cell infiltration (defined as an estimated CD8+ T cell infiltration level higher than upper quartile by TIMER) (STAR methods). Spearman’s rho statistic is used to estimate a rank-based measure of association.

# 应用场景
# Application scenarios

从下载TCGA数据开始，进行TIMER打分，根据某一类免疫细胞分组，计算表观遗传调控因子的表达与细胞毒性T淋巴细胞CTL评分之间的相关性，并画出柱形图。

把TCGA表达数据跟免疫浸润、表观遗传都联系起来了，或许对挖掘调控机制有启发。

更多免疫浸润FigureYa看这里<https://k.youshop10.com/VfrgxyYb>

转录调控机制挖掘FigureYa看这里<https://k.youshop10.com/ohh48vwq>

Starting from downloading TCGA data, perform TIMER scoring, group by a specific type of immune cell, calculate the correlation between the expression of epigenetic regulatory factors and the cytotoxic T lymphocyte (CTL) score, and plot a bar chart.

This connects TCGA expression data with immune infiltration and epigenetics, which may provide insights into regulatory mechanisms.

For more immune infiltration figures, check FigureYa here: <https://k.youshop10.com/VfrgxyYb>

For transcriptional regulatory mechanism exploration, check FigureYa here: <https://k.youshop10.com/ohh48vwq>

# 环境设置
# Environment Setup


```{r}
source("install_dependencies.R")
```

```{r eval=FALSE}

install.packages(c("ggcorrplot", "ggprism"))

# immunedeconv依赖包的安装
# Installation of the immunedeconv dependency package
remotes::install_github("cran/limSolve")
if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install("quantiseqr")

# immunedeconv的安装方法看这里：https://github.com/icbi-lab/immunedeconv
# For immunedeconv installation instructions, see: https://github.com/icbi-lab/immunedeconv
remotes::install_github("icbi-lab/immunedeconv")
```

# 加载包
# Loading packages

```{r}
library(ggprism)
library(magrittr)
library(tidyverse)
library(ggcorrplot)
library(immunedeconv)
library(TCGAbiolinks)
library(org.Hs.eg.db)
library(clusterProfiler)
library(SummarizedExperiment)

# 自定义函数，把FPKM转换成TPM
# Custom function to convert FPKM to TPM
fpkmToTpm <- function(fpkm) {exp(log(fpkm) - log(sum(fpkm)) + log(1e6))}

# 显示英文报错信息
# Show English error messages
Sys.setenv(LANGUAGE = "en")

# 禁止chr转成factor
# Prevent character-to-factor conversion
options(stringsAsFactors = FALSE)
```

# 下载TCGA数据并根据文章描述进行过滤
# Download TCGA data and filter according to the article description
