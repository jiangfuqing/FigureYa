---
title: "FigureYa282CMAP_XSum"
params:
  author: "Chen Yang; Yasi Zhang"
  reviewer: "Ying Ge"
  date: "2025-05-20"
output: html_document
---

**Author(s)**: `r params$author`
**Reviewer(s)**: `r params$reviewer`
**Date**: `r params$date`

# Academic Citation
If you use this code in your work or research, we kindly request that you cite our publication:

Xiaofan Lu, et al. (2025). FigureYa: A Standardized Visualization Framework for Enhancing Biomedical Data Interpretation and Research Efficiency. iMetaMed. https://doi.org/10.1002/imm3.70005


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 需求描述
# Demand description

小丫老师您好，我发现FigureYa131cMAP最近好像用不了了，有篇最近的文章好像也能用类似cmap的方法来进行药物预测，但这篇没有没有提供代码，请问能众筹一下吗，也可以替代一下FigureYa131cMAP。

Hello, Teacher Xiaoya. I noticed that FigureYa131cMAP seems to be unavailable recently. I came across a recent article that also uses a CMAP-like method for drug prediction, but the authors didn’t provide the code. Would it be possible to crowdsource a solution? This could also serve as an alternative to FigureYa131cMAP.

![](figure1.png)

出自：<https://elifesciences.org/articles/71880>

图1. LINCS数据驱动的治疗发现概述。基于"特征逆转"的计算方法工作原理。首先需要识别代表异常表达模式的疾病特征（G1、G2和G3表示疾病状态下上调的基因，而G4、G5和G6表示下调的基因）。利用这一特征，可以查询药理学扰动数据集，寻找能够逆转疾病表达模式的化合物（抑制G1、G2和G3的表达，同时诱导G4、G5和G6的表达）。确定候选化合物后，需要通过实验和临床验证将计算结果转化为临床应用。LINCS，集成网络细胞特征库。

Source: <https://elifesciences.org/articles/71880>

Figure 1. Overview of LINCS data-driven therapeutic discovery. The working principle of ‘signature reversion’-based computational approach. A disease signature representing discordant expression pattern needs first to be identified (G1, G2, and G3 stand for upregulated genes while G4, G5, and G6 stand for down-regulated genes in disease state). With this signature, pharmacologic perturbation data sets can be queried to find compounds with the ability to reverse disease expression pattern (suppress expression of G1, G2, and G3 and induce expression of G4, G5, and G6). After determining the candidate compounds, experimental and clinical validation are required to translate computational findings to clinical applications. LINCS, Library of Integrated Network-based Cellular Signatures.

# 应用场景
# Application scenarios

CMap分析主要涉及三个部分：

- 一是疾病的分子特征（disease signature）：以肿瘤为例，这个signature可以通过常规的癌与癌旁的差异分析得到。
- 二是药物的分子特征（druf signature）：这部分数据可以来自大家熟悉CMap数据库（包括了1309种药物在5个细胞系中的药物处理后的表达特征）。
- 三是特征匹配算法（signature matching methods）：大家常用的网页版的CMap通常使用基于Kolmogorov-Smirnov (KS)的方法来计算CMap score，但这种方法经证明并不是最优的计算cmap分析方法 (Yang et al. Elife 2022)。

例文这项研究 (Yang et al. Elife 2022, https://elifesciences.org/articles/71880) 证明了使用 eXtreme Sum (XSum) 的方法来进行CMap分析最有可能得到有意义的结果（XSum的性能经该研究评估要比大家常用的网页工具中的KS要好很多）。此外，该研究也确定了进行 CMap 分析时最优的参数（以下演示中会提到）。虽然该研究并不是使用 CMap 数据库而主要使用了LINCS数据库（关于CMap和LINCS的区别大家可以自己看看原文），但方法在两个数据库之间是通用的。因此，以下演示仍将使用大家熟悉的CMap数据；且所有分析全部可用R完成，不需要再基于任何网页工具。

如果大家使用了以下演示中的方法，记得引用例文文献（PMID: 35191375）。

The CMap analysis primarily involves three components:

- Molecular signatures of diseases (disease signature): Taking cancer as an example, this signature can be obtained through conventional differential analysis between tumor and adjacent normal tissues.
- Molecular signatures of drugs (drug signature): This part of the data can be sourced from the well-known CMap database (which includes expression profiles of 1,309 drugs across five cell lines after drug treatment).
- Signature matching algorithms (signature matching methods): The commonly used web-based CMap tool typically employs the Kolmogorov-Smirnov (KS) method to calculate the CMap score. However, this approach has been proven suboptimal for CMap analysis (Yang et al. Elife 2022).

The referenced study (Yang et al. Elife 2022, https://elifesciences.org/articles/71880) demonstrated that using the eXtreme Sum (XSum) method for CMap analysis is most likely to yield meaningful results (XSum's performance was evaluated in this study to be significantly better than the KS method used in the popular web tool). Additionally, the study identified the optimal parameters for conducting CMap analysis (which will be mentioned in the following demonstration). Although this study primarily utilized the LINCS database rather than CMap (for differences between CMap and LINCS, readers may refer to the original paper), the methods are applicable across both databases. Therefore, the following demonstration will still use the familiar CMap data, and all analyses can be completed entirely in R without relying on any web-based tools.

If you use the methods described in the following demonstration, please cite the referenced paper (PMID: 35191375).

# 环境设置
# Environment Setup


```{r}
source("install_dependencies.R")
```

```{r eval=FALSE}

BiocManager::install("PharmacoGx")
BiocManager::install("CoreGx", force = TRUE)
install.packages("shinyjs")
install.packages("shinydashboard")
install.packages("magicaxis")
install.packages("lsa")
install.packages("relations")
```

# 加载包
# Loading packages

```{r}
library(PharmacoGx)
library(parallel)
library(dplyr)
library(stringr)
library(tidyverse)
library(tibble)
library(clusterProfiler)
library(ggplot2)
library(ggrepel)
library(ggthemes)
library(gridExtra)

# 显示英文报错信息
# Show English error messages
Sys.setenv(LANGUAGE = "en")

# 禁止chr转成factor
# Prevent character-to-factor conversion
options(stringsAsFactors = FALSE)
```

# CMap数据下载及预处理
# Downloading and Preprocessing CMap Data

CMAP_gene_signatures.RData，处理好的CMap数据，下载地址<https://www.pmgenomics.ca/bhklab/sites/default/files/downloads/CMAP_gene_signatures.RData>

camp_sig.rds，这里作演示的文件只包含了部分药物。实际应用时要用完整的cmap数据，请自行下载CMAP_gene_signatures.RData，并运行以下代码，即可得到**完整的 camp_sig.rds 文件**。

CMAP_gene_signatures.RData – Preprocessed CMap data, available for download at <https://www.pmgenomics.ca/bhklab/sites/default/files/downloads/CMAP_gene_signatures.RData>

camp_sig.rds – This demo file contains only a subset of drugs. For practical applications, the full CMap dataset should be used. Please download CMAP_gene_signatures.RData and run the following code to generate **the complete camp_sig.rds file**.
