---
title: "FigureYa30nomogram_update"
author: "Dongqiang Zeng, Ying Ge; Yijing Chen"
date: "2025-5-20"
output: html_document
---

# Academic Citation
If you use this code in your work or research, we kindly request that you cite our publication:

Xiaofan Lu, et al. (2025). FigureYa: A Standardized Visualization Framework for Enhancing Biomedical Data Interpretation and Research Efficiency. iMetaMed. https://doi.org/10.1002/imm3.70005


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 需求描述
# Requirement description

画出新型nomogram图（d）和对比曲线（f、g）

Draw the new nomogram (d) and comparison curves (f, g)

![](example.png)

出自<https://linkinghub.elsevier.com/retrieve/pii/S2352396419301884>

图 3. (d-e) 基于 TMRS-RFS (d)、TMRS-OS (e) 和临床变量预测患者死亡率概率的列线图；(f-g) 图形描述了基于 TMRS-RFS (f) 和 TMRS-OS (g) 的列线图的校准情况，即预测结果与观察到的2年、3年和5年结果之间的一致性。相对于代表理想预测的45度线的曲线图显示了列线图的性能；（h-i）基于 TMRS-RFS（h）和 TMRS-OS （i）的列线图对2年、3年和5年风险的决策曲线分析。ADJC，辅助化疗；TMRS，肿瘤微环境风险评分；RFS，无复发生存率；OS，总生存率；Pr，概率；Nomo，列线图。

c森林图的画法可参考`FigureYa90subgroup`来画，h和i图可参考`FigureYa33DCA_update`。

from<https://linkinghub.elsevier.com/retrieve/pii/S2352396419301884>

Fig. 3. (d–e) Nomograms for predicting the probability of patient mortality based on TMRS-RFS (d), TMRS-OS (e) and clinical variables; (f–g) Plots depict the calibration of nomograms based on TMRS-RFS (f) and TMRS-OS (g) in terms of agreement between predicted and observed 2-year, 3-year, and 5-year outcomes. Nomogram performance is shown by the plot, relative to the 45-degree line, which represents the ideal prediction; (h–i) Decision curve analyses of the nomograms based on TMRS-RFS (h) and TMRS-OS (i) for 2-year, 3-year, and 5-year risk. ADJC, adjuvant chemotherapy; TMRS, tumour microenvironment risk score; RFS, relapse-free survival; OS, overall survival; Pr, probability; Nomo, nomogram.

The c forest plot can be drawn by referring to `FigureYa90subgroup`, and the h and i plots can be drawn by referring to `FigureYa33DCA_update`.

# 应用场景
# Application scenario

列线图（nomogram，诺莫图）是在平面直角坐标系中用一簇互不相交的线段表示多个独立变量之间函数关系的图。

将Logistic回归或Cox回归的结果进行可视化呈现，给出其发病风险或比例风险。

关注“小丫画图”微信公众号，回复“30”查看这两个图在更多文章中的应用。

A nomogram is a graph that represents a functional relationship between multiple independent variables in a plane rectangular coordinate system using a cluster of disjointed line segments.

It visualizes the results of a Logistic regression or Cox regression, giving the risk or proportional risk of developing a disease.

Follow “Xiaoya Drawing” WeChat Official Account, reply “30” to see the application of these two graphs in more articles.

# 环境设置
# Environment setting


```{r}
source("install_dependencies.R")
```

```{r eval=FALSE}

install.packages(c("rms", "nomogramEx", "regplot", "vioplot", "sm", "beanplot"))
```

加载包

load package

```{r}
library(survival)
library(regplot)
library(rms)
library(nomogramEx)
Sys.setenv(LANGUAGE = "en") #显示英文报错信息 display English error messages
options(stringsAsFactors = FALSE) #禁止chr转成factor prohibit the conversion of chr to factor
```

# 输入文件
# Input file

至少要有临床信息`easy_input.csv`，还可以把`FigureYa31lasso`输出的`lasso_output.txt`作为一列添加进来。

At least include the clinical information `easy_input.csv`, and also add the `FigureYa31lasso` output `lasso_output.txt` as a column.

```{r}
pbc <- read.table("easy_input.txt")

pbc$catbili <- cut(pbc$bili, breaks = c(-Inf, 2, 4, Inf),
                   labels=c("low", "medium", "high"))
pbc$died <- pbc$status == 2

head(pbc)
```

# 画nomogram
# Draw nomogram

这里提供两种风格的nomogram画法，用到不同的包

Here are two styles of nomogram drawing, using different packages

## 经典版
## Classic Edition

```{r,message=FALSE,warning=FALSE,fig.width=10,fig.height=6}
dd <- datadist(pbc)
options(datadist="dd")
options(na.action="na.delete")
summary(pbc$time)
coxpbc <- cph(formula = Surv(time,died) ~  age + catbili + sex + copper + stage + trt ,data=pbc,x=T,y=T,surv = T,na.action=na.delete)  #,time.inc =2920

print(coxpbc)
surv <- Survival(coxpbc)
surv3 <- function(x) surv(1825,x)
surv4 <- function(x) surv(2920,x)

x <- nomogram(coxpbc,fun = list(surv3,surv4),lp=T,
            funlabel = c('5-year survival Probability','8-year survival Probability'),
            maxscale = 100,fun.at = c(0.95,0.9,0.8,0.7,0.6,0.5,0.4,0.3,0.2,0.1))

pdf("nomogram_classical.pdf",width = 12,height = 10)
plot(x, lplabel="Linear Predictor",
     xfrac=.35,varname.label=TRUE, varname.label.sep="=", ia.space=.2,
     tck=NA, tcl=-0.20, lmgp=0.3,
     points.label='Points', total.points.label='Total Points',
     total.sep.page=FALSE,
     cap.labels=FALSE,cex.var = 1.6,cex.axis = 1.05,lwd=5,
     label.every = 1,col.grid = gray(c(0.8, 0.95)))
dev.off()
```

![](nomogram_classical.pdf)

输出公式

output formula
