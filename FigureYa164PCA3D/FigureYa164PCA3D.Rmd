---
title: "FigureYa164PCA3D"
author: "Bin Wei"
reviewer: "Ying Ge, Junyi Shen"
date: "2025-5-20"
output: html_document
---

# Academic Citation
If you use this code in your work or research, we kindly request that you cite our publication:

Xiaofan Lu, et al. (2025). FigureYa: A Standardized Visualization Framework for Enhancing Biomedical Data Interpretation and Research Efficiency. iMetaMed. https://doi.org/10.1002/imm3.70005


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 需求描述
# Requirement

像文章里这样的3D PCA图，展示不同组sample的关系。
A 3D PCA plot like the one in the article, showing the relationships between different sample groups.

![](example1.png)

Figure 1 Different immune phenotypes between glioma grades (A) Principal components analysis of immune-related genes between glioblastoma (GBM) and lower grade glioma (LGG).

![](example2.png)

Figure 2 An 8-gene local immune signature for patients with glioblastoma (GBM) (C) Distribution of samples based on the whole genome expression data. (D) High- and low-risk patients distributed on 2 sides based on the immune system process gene set.

出自<https://n.neurology.org/content/86/24/2226>
Source: <https://n.neurology.org/content/86/24/2226>

# 应用场景
# Application Scenarios

场景一：PCA一般用作质控，对测序数据的batch effect有个整体的评价。
Scenario 1: PCA is generally used for quality control, providing an overall assessment of the batch effect of sequencing data.

场景二：展示分组之间特定基因的差异。对比例文Figure 2 C和D，C用whole genome expression data，所有样本都混在一起，D用immune-related gene sets就可以看出 clearly divided patients into 2 sections, indicating their remarkable difference in immune phenotype.
类似的像例文Figure 1
 A用immune-related gene set 做PCA，indicating distinct immune phenotypes among histologic grades。
Scenario 2: Showing differences in specific genes between groups. Compare Figures 2 C and D. C uses whole genome expression data, lumping all samples together. D, using immune-related gene sets, clearly divides patients into two sections, indicating their remarkable differences in immune phenotype.
Similarly, Figure 1 A uses the immune-related gene set for PCA, indicating distinct immune phenotypes among histologic grades.

# 环境设置
# Environment Setup


```{r}
source("install_dependencies.R")

```

加载包
Load the package

```{r}
library(rgl)

Sys.setenv(LANGUAGE = "en") #显示英文报错信息 # Display English error messages
options(stringsAsFactors = FALSE) #禁止chr转成factor # Disable conversion of chr to factor
```

# 输入文件
# Input File

如果你自己的数据已经整理成easy_input*文件的格式，就直接跳到“PCA分析”。
If your data is already organized in easy_input* format, skip directly to "PCA Analysis."

## 输入文件的下载
## Download the Input File

基因表达矩阵，CGGA.mRNA_array_301_gene_level.20191128.txt，每行一个基因，每列一个sample。从CGGA下载：[Expression Data (gene level)](http://www.cgga.org.cn/download?file=download/20191128/CGGA.mRNA_array_301_gene_level.20191128.txt.zip&type=mRNA_array_301_gene_level&time=20191128) ，解压；
Gene expression matrix, CGGA.mRNA_array_301_gene_level.20191128.txt, one gene per row, one sample per column. Download [Expression Data (gene level)](http://www.cgga.org.cn/download?file=download/20191128/CGGA.mRNA_array_301_gene_level.20191128.txt.zip&type=mRNA_array_301_gene_level&time=20191128) from CGGA and unzip it.

分组信息，CGGA.mRNA_array_301_clinical.20191128.txt，至少包含CGGA_ID和Grade两列，这里用Grade为LGG和GBM分组。从CGGA下载：[Clinical Data](http://www.cgga.org.cn/download?file=download/20191128/CGGA.mRNA_array_301_clinical.20191128.txt.zip&type=mRNA_array_301_clinical&time=20191128)，解压；
Grouping information, CGGA.mRNA_array_301_clinical.20191128.txt, contains at least two columns: CGGA_ID and Grade. Here, Grade is used to group LGG and GBM. Download [Clinical Data](http://www.cgga.org.cn/download?file=download/20191128/CGGA.mRNA_array_301_clinical.20191128.txt.zip&type=mRNA_array_301_clinical&time=20191128) from CGGA and unzip it.

从MSigDB下载免疫相关基因，用这个方法还可以下载其他感兴趣通路的基因：
Download immune-related genes from MSigDB. This method can also be used to download genes for other pathways of interest:

- [immune system process, M13664](https://www.gsea-msigdb.org/gsea/msigdb/download_geneset.jsp?geneSetName=IMMUNE_SYSTEM_PROCESS&fileType=txt)基因集合，重命名为"IMMUNE_SYSTEM_PROCESS_M13664.txt"；
- [immune response, M19817](https://www.gsea-msigdb.org/gsea/msigdb/download_geneset.jsp?geneSetName=IMMUNE_RESPONSE&fileType=txt)基因集合，重命名为"IMMUNE_RESPONSE_M19817.txt"。
- [immune system process, M13664](https://www.gsea-msigdb.org/gsea/msigdb/download_geneset.jsp?geneSetName=IMMUNE_SYSTEM_PROCESS&fileType=txt) gene set, renamed "IMMUNE_SYSTEM_PROCESS_M13664.txt";
- [immune response, The gene set [M19817](https://www.gsea-msigdb.org/gsea/msigdb/download_geneset.jsp?geneSetName=IMMUNE_RESPONSE&fileType=txt) has been renamed to "IMMUNE_RESPONSE_M19817.txt".

## 读取基因表达矩阵
## Read the gene expression matrix
