---
title: "FigureYa274MuSiCbulkProop"
params:
  author: "Yandong Zheng; Yasi Zhang"
  reviewer: "Ying Ge"
  date: "2025-09-12"
output: html_document
---

**Author(s)**: `r params$author`
**Reviewer(s)**: `r params$reviewer`
**Date**: `r params$date`

# Academic Citation
If you use this code in your work or research, we kindly request that you cite our publication:

Xiaofan Lu, et al. (2025). FigureYa: A Standardized Visualization Framework for Enhancing Biomedical Data Interpretation and Research Efficiency. iMetaMed. https://doi.org/10.1002/imm3.70005

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 需求描述
# Demand description

用MuSic反卷积推算bulk组的细胞类型。

出自<https://www.nature.com/articles/s41467-018-08023-x>

Using MuSic deconvolution to infer cell types in bulk groups.

Source: <https://www.nature.com/articles/s41467-018-08023-x>

# 应用场景
# Application scenarios

MuSic这个软件大概有三个功能：

- 第一个就是直接根据单细胞数据和bulk数据预测bulk中大概含有单细胞鉴定到的哪几种细胞类型
- 第二个是先聚类，然后根据聚类信息和输入的marker list做，感觉主观性强
- 第三个是两个单细胞数据集进行相互验证，参考意义不大

流程跟着教程跑就好，官方详细教程见：<https://xuranw.github.io/MuSiC/articles/MuSiC.html#sample-analysis-1>

跟FigureYa71ssGSEA<https://k.youshop10.com/q7HAxIw2>的相似之处：核心理念都是用单细胞的数据算出来每种细胞类型的marker gene，然后看这些基因中的哪些在bulk中高表达。

同样用到单细胞和bulk的FigureYa272scBulkCCCI<https://k.youshop10.com/=fQQh=1T>，借助scRNA-seq找到的signature genes，推断bulk RNA-seq样本的细胞类群互作网络。

更多单细胞分析画图看这里<https://k.youshop10.com/McawGY6=>

The MuSiC software has approximately three main functions:

- The first is to directly predict which cell types identified from single-cell data are likely present in bulk data, based on both single-cell and bulk datasets.
- The second involves clustering first and then using the clustering information along with an input marker list, which tends to be more subjective.
- The third is mutual validation between two single-cell datasets, though its reference value is relatively limited.

The workflow can be followed according to the tutorial. For the official detailed tutorial, see: <https://xuranw.github.io/MuSiC/articles/MuSiC.html#sample-analysis-1>

Similarities with FigureYa71ssGSEA<https://k.youshop10.com/q7HAxIw2>: The core concept of both is to use single-cell data to calculate marker genes for each cell type and then identify which of these genes are highly expressed in bulk data.

Another tool that also utilizes both single-cell and bulk data is FigureYa272scBulkCCCI<https://k.youshop10.com/=fQQh=1T>. It leverages signature genes identified from scRNA-seq to infer cell-cell interaction networks in bulk RNA-seq samples.

For more single-cell analysis and visualization, check here: <https://k.youshop10.com/McawGY6=>

> 比较难的就是构建数据集，本文档带大家解决这个问题。

> The most challenging part is constructing the dataset, and this document will guide you through solving this issue.

分两种情况，分别带大家跑通：

- 第一种方案：**不预分组**预测bulk数据中细胞类型占比
- 第二种方案：**基于细胞类型预分组**预测bulk数据中细胞类型占比

We will cover two scenarios to help you successfully complete the analysis:

- Option 1: Predicting cell type proportions in bulk data **without pre-grouping**.
- Option 2: Predicting cell type proportions in bulk data **based on pre-grouped cell types**.


# 环境设置
# Environment Setup

```{r}
source("install_dependencies.R")
devtools::install_github('xuranw/MuSiC')
```

# 加载包
# Loading packages

```{r}
library(Seurat)
library(SeuratData)
library(patchwork)
library(dplyr)
library(MuSiC)
library(pheatmap)
library(magrittr)
library(Biobase)
library(glmGamPoi)
library(SingleCellExperiment)

# 显示英文报错信息
# Show English error messages
Sys.setenv(LANGUAGE = "en")

# 禁止chr转成factor
# Prevent character-to-factor conversion
options(stringsAsFactors = FALSE)
```

# 第一种方案: 不预分组预测bulk数据中细胞类型占比
# Option 1: Predicting Cell Type Proportions in Bulk Data Without Pre-Grouping

## 输入文件
## Input Files

### 构建单细胞数据集
### Constructing the Single-Cell Dataset

`ifnb` - A Seurat object with the PBMC control/IFNB-stimulated dataset。出自<https://pubmed.ncbi.nlm.nih.gov/29227470/>，已被打包到SeuratData里，我们直接安装、加载它。

为了友好对接目前主流的Seurat单细胞分析流程，使用SeuratData包钟的ifnb数据集做示例数据，示例数据ifnb有STIM和CTRL两组。

`ifnb` – A Seurat object containing the PBMC control/IFNB-stimulated dataset, sourced from <https://pubmed.ncbi.nlm.nih.gov/29227470/>. This dataset has been pre-packaged in SeuratData, so we can directly install and load it.

To ensure compatibility with the current mainstream Seurat single-cell analysis pipeline, we use the ifnb dataset from the SeuratData package as an example. The example dataset ifnb contains two groups: STIM (stimulated) and CTRL (control).
