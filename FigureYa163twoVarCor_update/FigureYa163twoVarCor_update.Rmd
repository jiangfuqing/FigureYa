---
title: "FigureYa163twoVarCor_update"
author: "Xiaofan Lu"
reviewer: "Ying Ge, Junyi Shen"
date: "2025-5-20"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 需求描述
# Requirement Description

**需求一：**绘制多组数据在两个变量上的相关性散点图。
**Requirement 1:** Plot a scatter plot of the correlations between multiple data sets on two variables.

![](example.png)

Fig. 1 Correlations between DNAm age and chronological age and other molecular characteristics of DNAm age groups. a DNAm age of 200 mixed normal cervical samples predicts chronological age with a decent correlation coefficient, whereas such correlation was much weaker in 252 tumour samples from TCGA.

**图的解读**
**Interpretation of the Figure**

不同于普通相关性散点图，这里添加了更丰富的信息，类似的有FigureYa143survCor：
Unlike ordinary correlation scatter plots, this one adds richer information, similar to FigureYa143survCor:

- 用点的大小展示横纵坐标的差异，类似于FigureYa59vocano用点的大小体现差异倍数和pvalue；
- 用了两种颜色，使得两组数据可以画一起，还可用更多颜色展示更多组。
- The size of the dot indicates the difference between the horizontal and vertical axes, similar to FigureYa59vocano, which uses the size of the dot to indicate the fold difference and p-value;
- Two colors are used to allow the two data sets to be plotted together, and more colors can be used to display more groups.

**需求二：**审稿人要求我比较两个相关性大小有没有统计学差异，我想知道老师这篇文章里Fisher's r-to-z transformation是怎么计算的？
**Requirement 2:** The reviewer asked me to compare the two correlations to see if they are statistically significant. I would like to know how Fisher's r-to-z transformation is calculated in this paper.

![](method.jpg)

出自<https://clinicalepigeneticsjournal.biomedcentral.com/articles/10.1186/s13148-020-0822-y>
From <https://clinicalepigeneticsjournal.biomedcentral.com/articles/10.1186/s13148-020-0822-y>

# 应用场景
# Application Scenarios

展示两个基因/性状之间的相关性，2组/3组/多组都可以画一起。
Show the correlation between two genes/traits. Two, three, or more groups can be plotted together.

- 这里用颜色区分每个分组，如果太多怕区分不开，可参考FigureYa125Fishertest、FigureYa76corrgram或FigureYa97correlationV3，再多的话可以用FigureYa73batchCorrelation做批量相关性分析和画图。可进入“微店——分类——相关性”，查看更多相关性的展示方式。
- Here, each group is distinguished by color. If there are too many groups to distinguish, refer to FigureYa125 Fishertest, FigureYa76 corrgram, or FigureYa97 correlationV3. For even more, use FigureYa73 batchCorrelation for batch correlation analysis and plotting. Go to "WeChat Store - Category - Correlation" to view more ways to display correlations.

- 这里要求两组数据的横纵坐标一致，如果你的两组数据横纵坐标不一致，可参考FigureYa62twoAxis和FigureYa96R2的画法
- This requires the two data sets to have consistent horizontal and vertical coordinates. If your two data sets do not, refer to FigureYa62twoAxis and FigureYa96R2 for more information.

# 环境设置
# Environment Settings

```{r}
Sys.setenv(LANGUAGE = "en") #显示英文报错信息 #Display English error messages
options(stringsAsFactors = FALSE) #禁止chr转成factor #Disable conversion of chr to factor
```

自定义函数，用于比较不同组相关性是否有统计学差异
Custom function used to compare statistical differences in correlations between different groups

```{r}
test2cor = function(x1, x2, y1, y2, method = "pearson") {

  # x1：第一组相关性分析的变量1
  # x2：第一组相关性分析的变量2
  # y1：第二组相关性分析的变量1
  # y2：第二组相关性分析的变量2
  # method：相关性分析方法，默认为皮尔斯相关性
  # x1: Variable 1 for the first correlation analysis
  # x2: Variable 2 for the first correlation analysis
  # y1: Variable 1 for the second correlation analysis
  # y2: Variable 2 for the second correlation analysis
  # method: Correlation analysis method, default is Pierce correlation

  # 统计定义： Fisher’s r-to-z transformation was used to calculate a value of z that was applied to assess the significance of the difference between two correlation coefficients.
  # Statistical Definition: Fisher’s r-to-z transformation was used to calculate the value of z that was applied to assess the significance of the difference between two correlation coefficients.

  cor1 = cor.test(x1, x2, method = method)
  cor2 = cor.test(y1, y2, method = method)

  r1 = cor1$estimate
  r2 = cor2$estimate
  n1 = sum(complete.cases(x1, x2))
  n2 = sum(complete.cases(y1, y2))
  fisher = ((0.5*log((1+r1)/(1-r1)))-(0.5*log((1+r2)/(1-r2))))/((1/(n1-3))+(1/(n2-3)))^0.5

  p.value = (2*(1-pnorm(abs(fisher))))

  result= list(
    "cor1" = list(
      "estimate" = as.numeric(cor1$estimate),
      "p.value" = cor1$p.value,
      "n" = n1
    ),
    "cor2" = list(
      "estimate" = as.numeric(cor2$estimate),
      "p.value" = cor2$p.value,
      "n" = n2
    ),
    "p.value.twosided" = as.numeric(p.value), # 双侧检验p值 # Two-sided test p-value
    "p.value.onesided" = as.numeric(p.value) / 2 # 单侧检验p值，根据相关性大小自行判断是“greater”还是“less” # One-sided test p-value, judge whether it is "greater" or "less" based on the size of the correlation
  )
  cat(paste(sep="",
            "cor1: r=", format(result$cor1$estimate, digits=3), ", p=", format(result$cor1$p.value, digits=3), ", n=", result$cor1$n, "\n",
            "cor2: r=", format(result$cor2$estimate, digits=3), ", p=", format(result$cor2$p.value, digits=3), ", n=", result$cor2$n, "\n",
            "diffence: p(one-sided)=", format(result$p.value.onesided, digits=3), ", p(two-sided)=", format(result$p.value.twosided, digits=3), "\n"
  ))
  return(result);
}
```

# 输入文件
# Input file

easy_input.csv，第一列和第二列是连续变量，分别对应图上的横纵坐标，第三列是分组。
easy_input.csv, the first and second columns are continuous variables, corresponding to the horizontal and vertical coordinates on the graph, respectively. The third column is the grouping.

```{r}
cor.data <- read.csv("easy_input.csv", row.names = NULL, check.names = F, header = T, stringsAsFactors = F)
head(cor.data)
dim(cor.data)
table(cor.data$class)
```

# 分别计算不同组的相关性
# Calculate correlations for different groups separately
