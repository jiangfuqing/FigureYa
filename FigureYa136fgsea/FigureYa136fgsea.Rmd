---
title: "FigureYa136fgsea"
author: "Rongfang Shen"
reviewer: "Ying Ge, Junyi Shen"
date: "2025-5-20"
output: html_document
---

# Academic Citation
If you use this code in your work or research, we kindly request that you cite our publication:

Xiaofan Lu, et al. (2025). FigureYa: A Standardized Visualization Framework for Enhancing Biomedical Data Interpretation and Research Efficiency. iMetaMed. https://doi.org/10.1002/imm3.70005


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 需求描述
## Requirement description

用paper里这种类似fgsea的图展示GSEA富集分析结果。兼容Java版和clusterProfiler版GSEA：
Use a fgsea-like graph in the paper to display the results of GSEA enrichment analysis. Compatible with Java and clusterProfiler versions of GSEA:

1. Java版GSEA的输出结果作为输入，到画图；
1. Use the output of Java version of GSEA as input to draw a graph;

2. 用clusterProfiler做GSEA，到画图。这里重点在画DIYpaper里的这幅图，如果有关于clusterProfiler做富集分析的问题，建议在“小丫画图群”或“小丫画图群-医学统计”里发红包提问。
2. Use clusterProfiler to do GSEA and then draw a graph. The focus here is on drawing the graph in DIYpaper. If you have any questions about clusterProfiler enrichment analysis, it is recommended to send a red envelope to ask questions in "Xiaoya Drawing Group" or "Xiaoya Drawing Group-Medical Statistics".

![](example.jpg)

出自<https://www.sciencedirect.com/science/article/pii/S0092867418303581?via%3Dihub#app2>
From <https://www.sciencedirect.com/science/article/pii/S0092867418303581?via%3Dihub#app2>

Figure 2. Biological processes associated with cancer stemness
(A) Gene Set Enrichment Analysis showing RNAseq-based stemness signature evaluated in the context of gene sets representative for Hallmarks of Stemness and Cancer.

**图的解析**
**Analysis of the figure**

1. 每行一个geneset，通常我们会用MsigDB里的geneset。而这篇文章的作者是从其他16篇文献中收集的，每篇文章的基因作为一个geneset。HT曾分享过类似的思想，推荐阅读：《富集分析，十年的思考 | “小丫画图群”讨论记录》<https://mp.weixin.qq.com/s/O1xd5l5h33fXUWOvX3UBGw>
2. 基因按foldchange排序，当遇到属于这个geneset的基因时，就会画黑色竖线（bar）。纵坐标是foldchange，因此左半边是genes upregulate，右半边是gene downregulated。
3. 右侧列出每个geneset的size、NES、FDR等信息，集中在一个图里，整齐并不拥挤，展示的信息量还非常大。
4. 如果gene set少些，甚至可以像FigureYa60GSEA_clusterProfiler那样，在rank上标出关键基因。
1. Each line has a geneset. Usually we use the genesets in MsigDB. The author of this article collected them from 16 other articles, and the genes in each article are used as a geneset. HT has shared similar ideas. Recommended reading: "Enrichment Analysis, Ten Years of Thinking | Discussion Records of "Xiao Ya Drawing Group"" <https://mp.weixin.qq.com/s/O1xd5l5h33fXUWOvX3UBGw>
2. Genes are sorted by foldchange. When encountering a gene belonging to this geneset, a black vertical line (bar) will be drawn. The vertical axis is foldchange, so the left half is genes upregulated and the right half is genes downregulated.
3. The size, NES, FDR and other information of each geneset are listed on the right side, concentrated in one figure, which is neat and not crowded, and the amount of information displayed is still very large.
4. If there are fewer gene sets, you can even mark the key genes on the rank like FigureYa60GSEA_clusterProfiler.

## 应用场景
## Application scenario

做完GSEA富集分析，接下来就该考虑如何在一张图中合理的展示多组或多条通路的结果。
After completing the GSEA enrichment analysis, the next step is to consider how to reasonably display the results of multiple groups or multiple pathways in one figure.

更多画法可参考FigureYa13GSEA_Java或FigureYa60GSEA_clusterProfiler。
For more drawing methods, please refer to FigureYa13GSEA_Java or FigureYa60GSEA_clusterProfiler.

另外，GSEA的应用不仅仅是输入差异分析得到的基因foldchange/adj.p list，用来展示差异表达的通路，GSEA其实还有更多的应用方式，例如[RNA蛋白质关联分析](https://www.sciencedirect.com/science/article/pii/S0016508517357426?via%3Dihub)Figure3等，或者像例文那样探讨感兴趣的指标（stemness index与其他gene list的关系）。
In addition, the application of GSEA is not only to input the gene foldchange/adj.p list obtained by differential analysis to display the differentially expressed pathways. GSEA actually has more applications, such as [RNA protein association analysis](https://www.sciencedirect.com/science/article/pii/S0016508517357426?via%3Dihub)Figure3, etc., or explore the indicators of interest (the relationship between stemness index and other gene lists) as in the example article.

这里将展示三种方法：
Here are three methods:

- 方法一：fgsea直接出图，需要后期用AI等软件处理；
- 方法二：用clusterProfiler做GSEA，DIY出paper里的图；
- 方法三：用Java版GSEA的输出文件作为输入，DIY出paper里的图。
- Method 1: fgsea directly outputs the picture, which needs to be processed by AI and other software later;
- Method 2: Use clusterProfiler to do GSEA and DIY the picture in the paper;
- Method 3: Use the output file of the Java version of GSEA as input to DIY the picture in the paper.


## 环境设置
## Environment settings

```{r}
source("install_dependencies.R")
library(fgsea)
library(clusterProfiler)
library(enrichplot)
library(xlsx)
library(tidyverse)
options(stringsAsFactors = F)
Sys.setenv(LANGUAGE = "en")
```

## 方法一和二的输入文件
## Input files for methods 1 and 2

- DNAmethylation_and_RNAexpression_Stemness_Signatures.xlsx: 基因排序，相当于Java版GSEA的rnk文件，至少包含两列：基因ID和用于排序的数值（foldchange、pvalue等等）。这里用的是[文章附属文件](https://api.gdc.cancer.gov/data/401e9e48-12d2-4177-81a7-10043a32867c)DNAmethylation_and_RNAexpression_Stemness_Signatures.xlsx，对stemness index感兴趣的小伙伴可以按照文章给出的[代码](http://tcgabiolinks.fmrp.usp.br/PanCanStem/)重复出该文件。
- DNAmethylation_and_RNAexpression_Stemness_Signatures.xlsx: Gene ranking, equivalent to the rnk file of Java version GSEA, contains at least two columns: gene ID and numerical values used for ranking (foldchange, pvalue, etc.). Here we use the [article attachment file](https://api.gdc.cancer.gov/data/401e9e48-12d2-4177-81a7-10043a32867c)DNAmethylation_and_RNAexpression_Stemness_Signatures.xlsx. Friends who are interested in stemness index can reproduce the file according to the [code](http://tcgabiolinks.fmrp.usp.br/PanCanStem/) given in the article.

- h.all.v7.0.symbols.gmt，signature list。这里以MsigDB中的hallmark为例。例文是作者去文献里收集的16个genesets，实际应用时可以用MsigDB的geneset，也可以自己去文献里收集，原理看这篇：《富集分析，十年的思考 | “小丫画图群”讨论记录》<https://mp.weixin.qq.com/s/O1xd5l5h33fXUWOvX3UBGw>。
- h.all.v7.0.symbols.gmt, signature list. Here we take the hallmark in MsigDB as an example. The example article is 16 genesets collected by the author from the literature. In actual application, you can use the genesets of MsigDB, or you can collect them from the literature yourself. For the principle, please refer to this article: "Enrichment Analysis, Ten Years of Thinking | Discussion Record of "Xiao Ya Drawing Group"" <https://mp.weixin.qq.com/s/O1xd5l5h33fXUWOvX3UBGw>.
