---
title: "FigureYa138NiceCalibration"
author: "Xiaofan Lu"
reviewer: "Ying Ge, Junyi Shen"
date: "2025-5-20"
output: html_document
---

# Academic Citation
If you use this code in your work or research, we kindly request that you cite our publication:

Xiaofan Lu, et al. (2025). FigureYa: A Standardized Visualization Framework for Enhancing Biomedical Data Interpretation and Research Efficiency. iMetaMed. https://doi.org/10.1002/imm3.70005


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 需求描述
## Requirement description

想要众筹这个漂亮的calibration图（A），用于logistics回归，要有这个Hosmer-Lemeshow test。
I want to crowdfund this beautiful calibration graph (A) for logistics regression, which requires this Hosmer-Lemeshow test.

![](example.png)

出自<https://www.frontiersin.org/articles/10.3389/fonc.2019.00488/full>
From <https://www.frontiersin.org/articles/10.3389/fonc.2019.00488/full>

FIGURE 6 | Model performance and clinical usefulness of the LNM-nomogram. (A) Calibration curve with Hosmer-Lemeshow test of the LNM-nomogram in the training set of TCGA-cohort. Calibration curve depicts the calibration of the fitted model in terms of the **agreement between the predicted risk of LN metastasis and real observed outcomes**. The x-axis represents the predicted LN metastasis risk and y-axis represents the actual LN metastasis rate. The pink solid line represents the performance of the LNM-nomogram, of which a closer fit to the diagonal dotted blue line represents an ideal prediction. The calibration curve was drawn by plotting ˆP on the x-axis and Pc = 1 + exp 􀀀− 0 + 1L−1on the y-axis, where Pc is the actual probability, L = logit ˆP , ˆP is predicted probability, 0 is corrected intercept, and 1 is slope estimates.

**Validation of the LNM Nomogram and Its Clinical Usefulness**

Total points calculated by LNM nomogram for each sample in the testing set was determined to be a significant predictor when performing logistic regression (p = 0.032), and no departure from perfect fit was identified (p = 0.485) (Figure 6A)

**图的解读**
**Interpretation of the figure**

上文找到了预测淋巴结转移（LNM）的指标LNM Nomogram，接下来验证和评价其临床可用性。
- 用Calibration来评价一致性/标定度/校准度，即预测值和真实值之间的差异（本文）档）
- 用ROC来评价区分度，即特异性和敏感性（可参考FigureYa24ROC）；
- 用DCA来帮助确定高风险的患者进行干预、低风险的患者避免过度医疗（可参考FigureYa33DCA）。
The above article found the indicator LNM Nomogram for predicting lymph node metastasis (LNM). Next, its clinical usability will be verified and evaluated.
- Use Calibration to evaluate consistency/calibration/calibration, that is, the difference between the predicted value and the true value (this article) document)
- Use ROC to evaluate discrimination, that is, specificity and sensitivity (see FigureYa24ROC);
- Use DCA to help determine high-risk patients for intervention and low-risk patients to avoid over-medicalization (see FigureYa33DCA).

## 应用场景
## Application scenario

可用于评价诊断模型，是针对逻辑回归的。不能做预后模型，预后的calibration是不会曲折的。
It can be used to evaluate diagnostic models, which is for logistic regression. It cannot be used to make prognostic models, and the calibration of prognosis will not be tortuous.

通常用Hosmer-Lemeshow good of fit test（拟合优度检验）来评价预测模型的校准度。Hosmer-Lemeshow检验的思路和SPSS实现方法看这篇：<https://zhuanlan.zhihu.com/p/35574120>
The Hosmer-Lemeshow good of fit test is usually used to evaluate the calibration of the prediction model. For the idea of Hosmer-Lemeshow test and the SPSS implementation method, please refer to this article: <https://zhuanlan.zhihu.com/p/35574120>

Discrimination（区分度）和Calibration（一致性/标定度）是评价预测模型效能的两个重要指标。例文中都有提及，详情看这篇：<http://www.dxy.cn/bbs/topic/38248198?from=recommend>
Discrimination (discrimination) and Calibration (consistency/calibration) are two important indicators for evaluating the effectiveness of prediction models. They are mentioned in the example text. For details, please refer to this article: <http://www.dxy.cn/bbs/topic/38248198?from=recommend>

## 环境设置
## Environment settings


```r

install.packages("ResourceSelection")
```

加载包
Loading Packages

```{r}
source("install_dependencies.R")
library(rms)
library(ResourceSelection)

Sys.setenv(LANGUAGE = "en") #显示英文报错信息 #Display English error message
options(stringsAsFactors = FALSE) #禁止chr转成factor #Disable conversion of chr to factor
```

## 输入文件
## Input file

easy_input.csv，每行一个sample。
- 第一列MetaScore和第二列MLL2突变，自变量；
- 第三列MetaStatus生存信息，因变量。
easy_input.csv, one sample per line.
- The first column is MetaScore and the second column is MLL2 mutation, independent variables;
- The third column is MetaStatus survival information, dependent variable.

```{r}
dat <- read.table("easy_input.txt",sep = "\t",check.names = F,stringsAsFactors = F,header = T,row.names = 1)
head(dat)
summary(dat$MetaScore)
table(dat$MLL2)
table(dat$MetaStatus)
```

## Hosmer-Lemeshow Goodness of Fit
